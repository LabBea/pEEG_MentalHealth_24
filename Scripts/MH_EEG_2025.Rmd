---
title: "R Notebook"
output: html_notebook
---



## Notebook Set-Up
***  

### Library
```{r}
library(here)
library(tidyverse)
library(devtools)
library(ggrepel)
library(ggpubr)
library(lme4)
library(sjPlot)
library(readxl)
library(huxtable)
library(parameters)
library(lattice)
library(r2mlm)
library(lmerTest)
library(effects)
library(equatiomatic)
library(finalfit)
library(rstatix)
library(arm)
library(reshape2)
library(simr)
library(pwr)
library(car)
library(splines)
```

### Commonly used functions
```{r}
#Write function for linear models
 ################################################
ggplotRegression <- function (fit) {
  require(ggplot2)
  ggplot(fit$model, aes_string(x = names(fit$model)[2], y = names(fit$model)[1])) + 
    geom_point() +
    stat_smooth(method = "lm", col = "red", linetype = "dashed", linewidth = 1) +
    labs(title = paste("Adj R2 = ",signif(summary(fit)$adj.r.squared, 5),
                     "Intercept =",signif(fit$coef[[1]],5 ),
                     " Slope =",signif(fit$coef[[2]], 5),
                     " P =",signif(summary(fit)$coef[2,4], 5)))
}
```

## Part 1: Data Overview
***  
Delta waves: 1 - 4 Hz  
Theta waves: 4 - 8 Hz  
Alpha waves: 8 - 13 Hz  
Beta waves: 13 - 32 Hz
Gamma waves: 32-60 Hz
</ br>

Odd electrodes = left hemisphere  
Even electrodes = Right hemisphere


### 1.1 - Data Preperation
*** 
Load Spectral Data and merge with metadata
```{r}
# Part 1: Read and Clean the Spectral Power Data
################################################################################
Spectral_data <- read_delim(here("Data","Int_Absolute_Power.txt"))
Spectral_data$Visit <- Spectral_data$File
Spectral_data$Visit <- substr(Spectral_data$File, start = 6, stop = 8)
Spectral_data$File <- substr(Spectral_data$File, start = 1, stop = 4)
Spectral_data$Visit <- sub("[\\s_].*", "",Spectral_data$Visit)
Spectral_data <- Spectral_data[,c(1,19,2:18)]
Spectral_data <- Spectral_data %>% rename(ParticipantID = File)


# Change "O"s to 0s and change V to T in Visit #apply tupper
Spectral_data <- Spectral_data %>% mutate(Visit = case_when(Visit == "V1" ~ "T1", 
                                                            Visit == "V2" ~ "T2",
                                                            TRUE ~ Visit)) %>%
                                  mutate(ParticipantID = str_replace(ParticipantID, "O", "0")) %>%
                                  mutate(ParticipantID = toupper(ParticipantID)) %>%
                                  mutate(Visit = toupper(Visit))



#Rename wave values
Spectral_data <- Spectral_data %>%
  dplyr::mutate(Freq_int_name = dplyr::recode(Freq_int_name, 
                                  "all" = "All", 
                                  "delta" = "Delta", 
                                  "teta" = "Theta",
                                  "alfa" = "Alpha",
                                  "beta" = "Beta",
                                  "gamma" = "Gamma")) %>%
  dplyr::select(-c(Freq_interval, Condition)) # drop rando columns

#Find total power by wave type and convert all values to relative
Spectral_data <- Spectral_data %>% 
  mutate(Total_power_row = rowSums(across(c("AF3","AF4","F3","F4","F7","F8",
                                           "FC5","FC6","O1","O2","P7","P8","T7","T8")), 
                                   na.rm=TRUE)) %>%
  arrange(ParticipantID, Visit) %>%
  group_by(ParticipantID, Visit) %>%
  mutate(Total_power = ifelse(Freq_int_name == "All", sum(Total_power_row), NA)) %>%
  fill(Total_power, .direction = "down") %>%
  ungroup()

# Divide by 2 because the all wave sums to all the other waves
Spectral_data$Total_power <- Spectral_data$Total_power/2 

Spectral_data[,c("AF3","AF4","F3","F4","F7","F8",
                 "FC5","FC6","O1","O2","P7","P8","T7","T8")] <- Spectral_data[,c("AF3","AF4","F3","F4","F7","F8",
                                                                 "FC5","FC6","O1","O2","P7","P8","T7","T8")]/Spectral_data$Total_power

Spectral_data <- Spectral_data %>% mutate(Total_rel = rowSums(across(c("AF3","AF4","F3","F4","F7","F8",
                                        "FC5","FC6","O1","O2","P7","P8","T7","T8")), na.rm=TRUE))


# Part 2: Read and Clean the Metadata
################################################################################
Metadata <- read.csv(here("Data","pEEG_Metadata.csv"))
Metadata <- Metadata[,-1] #drop the rando first column

# Make a healthcare numeric column
Metadata$Healthcare_numeric  <- as.numeric(Metadata$Healthcare == "Private_Insurance")

#Log scale PHQ9
Metadata[,"logcatdi"]<-
  log(Metadata[,"catdi_severity"]+1)

#Scale to between 0 and 1
Metadata$CATDI_c <- (Metadata$logcatdi - min(Metadata$logcatdi, na.rm = TRUE)) / 
                  (max(Metadata$logcatdi, na.rm = TRUE) - min(Metadata$logcatdi, na.rm = TRUE))

#Log scale PHQ9
Metadata[,"logPHQ9"]<-
  log(Metadata[,"PHQ9"]+1)

#Log scale GAD7
Metadata[,"loggad7"]<-log(Metadata$GAD7+1)

#Scale to between 0 and 1
Metadata$PHQ9_c <- (Metadata$logPHQ9 - min(Metadata$logPHQ9, na.rm = TRUE)) / 
                  (max(Metadata$logPHQ9, na.rm = TRUE) - min(Metadata$logPHQ9, na.rm = TRUE))

# Add Race.Ethnicity Combo
Metadata <- Metadata %>% mutate(Race.Ethnicity = case_when(Race == "Black" & Ethnicity == "Not-Hispanic" ~ "Black",
                                                           Race == "Black" & Ethnicity == "Hispanic" ~ "Hispanic Black",
                                                           Race == "White" & Ethnicity == "Not-Hispanic" ~ "White",
                                                           Race == "White" & Ethnicity == "Hispanic" ~ "Hispanic",
                                                           TRUE ~ "Other"),
                                Race_Black = case_when(Race=="Black" ~ 1, .default = 0),
                                Ethnicity_Hispanic = case_when(Ethnicity == "Hispanic"~1, .default = 0))

# Center EGA and Age
Metadata$Age_c <- (Metadata$Age - min(Metadata$Age, na.rm = TRUE)) / 
                  (max(Metadata$Age, na.rm = TRUE) - min(Metadata$Age, na.rm = TRUE))
Metadata$EGA_c <- (Metadata$EGA - min(Metadata$EGA, na.rm = TRUE)) / 
                  (max(Metadata$EGA, na.rm = TRUE) - min(Metadata$EGA, na.rm = TRUE))
Metadata$T1_EGA_c <- (Metadata$T1_EGA - min(Metadata$T1_EGA, na.rm = TRUE)) / 
                  (max(Metadata$T1_EGA, na.rm = TRUE) - min(Metadata$T1_EGA, na.rm = TRUE))


#Find Antenatal EGA
Metadata$Antenatal_EGA<- ifelse(Metadata$Visit != "PP", Metadata$EGA, NA)
Metadata$Antenatal_EGA_c <- (Metadata$Antenatal_EGA - min(Metadata$Antenatal_EGA, 
                                                          na.rm = TRUE)) /
                 (max(Metadata$Antenatal_EGA , na.rm = TRUE) - min(Metadata$Antenatal_EGA,
                                                                   na.rm = TRUE))

Metadata$Postpartum_Days_c<-(((Metadata$Postpartum_Days - min(Metadata$Postpartum_Days, 
                                                              na.rm = TRUE)) /
                 (max(Metadata$Postpartum_Days , na.rm = TRUE) - min(Metadata$Postpartum_Days,
                                                                     na.rm = TRUE)))*6/40)+1

Metadata <- Metadata %>%
  mutate(SplitEGA_c = coalesce(Antenatal_EGA_c, Postpartum_Days_c))
Metadata$loggad7_c <- (Metadata$loggad7 - min(Metadata$loggad7, na.rm = TRUE)) /
                  (max(Metadata$loggad7, na.rm = TRUE) - min(Metadata$loggad7, na.rm = TRUE))


# Merge Data together
################################################################################
Spec_Meta_data <- merge(Metadata, Spectral_data, by = c("ParticipantID", "Visit"), all = FALSE)

#Drop SV number label for better grouping
Spec_Meta_data$Visit <- substr(Spec_Meta_data$Visit, start = 1, stop = 2)

# Drop duplicate rows
Spec_Meta_data <- unique(Spec_Meta_data)
```

### 1.2 Cohort Information  

__Demographic Table__  
```{r}
# Filter down to all observations
All_obs <- Spec_Meta_data %>% subset(Freq_int_name == "All")
All_obs_tabledata <- All_obs
All_obs_tabledata$EGA <- All_obs_tabledata$EGA/7
# Number of individuals 
length(unique(All_obs_tabledata$ParticipantID))


distinct_df <- All_obs_tabledata #%>% distinct(ParticipantID, .keep_all = TRUE)

# Add categories
distinct_df <- distinct_df %>% 
  mutate(PHQ9_category = case_when(
    PHQ9 <= 4 ~ "Normal",
    PHQ9 >= 5 & PHQ9 <= 9 ~ "Mild",
    PHQ9 >= 10 ~ "Moderate/Severe",
    is.na(PHQ9) ~ "Missing")) %>% 
  mutate(GAD7_category = case_when(
    GAD7 <= 4 ~ "Normal",
    GAD7 >= 5 & GAD7 <= 9 ~ "Mild",
    GAD7 >= 10 ~ "Moderate/Severe",
    is.na(GAD7) ~ "Missing"))

# Final Crosstable 
#######################################################
explanatory = c("EGA","Age","Race.Ethnicity","PHQ9","PHQ9_category", "GAD7", "GAD7_category",
                "Hx_Depression","Hx_Anxiety")
dependent = "Visit"

visit_order <- c("T1", "SV", "T2", "T3", "PP")
distinct_df$Visit <- factor(distinct_df$Visit, levels = visit_order)

distinct_df %>%
  summary_factorlist(dependent, explanatory, add_col_totals = T,
  p=TRUE, add_dependent_label=TRUE) -> t1

t1$p <- as.character(round(as.numeric(t1$p),digit=2))
t1$p <- replace(t1$p, is.na(t1$p), "")

knitr::kable(t1, align=c("l", "l", "r", "r", "r", "r", "r", "r"))

# Crosstable for just the cohort
#######################################################
distinct_df <- All_obs_tabledata %>% distinct(ParticipantID, .keep_all = TRUE)
explanatory = c("Age","Race.Ethnicity",
                "Hx_Depression","Hx_Anxiety")
dependent = "Healthcare"


distinct_df %>%
  summary_factorlist(dependent, explanatory, add_col_totals = T,
  p=TRUE, add_dependent_label=TRUE) -> t1

t1$p <- as.character(round(as.numeric(t1$p),digit=2))
t1$p <- replace(t1$p, is.na(t1$p), "")

knitr::kable(t1, align=c("l", "l", "r", "r", "r", "r", "r", "r"))


distinct_df <- All_obs_tabledata %>% distinct(ParticipantID, .keep_all = TRUE)

distinct_df %>%
  summary_factorlist(
    explanatory = c("Age", "Race.Ethnicity", "Healthcare", "Hx_Depression", "Hx_Anxiety"), 
    dependent = NULL,  # No dependent variable
    add_col_totals = TRUE,
    p = FALSE,  # No p-values since there's no dependent variable
    add_dependent_label = FALSE) 
```



Median number of visits

```{r}
median_repeats <- All_obs_tabledata %>%
  count(ParticipantID) %>%  
  summarise(median_repeats = median(n)) %>%  
  pull(median_repeats)

print(median_repeats)
```


```{r}
mean(All_obs$Postpartum_Days, na.rm=TRUE)/7
sd(All_obs$Postpartum_Days, na.rm=TRUE)/7
```


### 1.3 PHQ9 by Visit

Check normalcy to determine if t-test or if wilcox rank sum on log centered PHQ9
```{r}
# Step 1 - Run Shapiro Wilks to test for normalacy of the data
#############################################################################
shapiro_result <- shapiro.test(All_obs$PHQ9_c)
p_value <- shapiro_result$p.value

# Step 2 - Print p-value on the histogram
#############################################################################
# Create the histogram plot
hist(All_obs$PHQ9_c, breaks=100, 
     main = "Distribution of PHQ9", 
     xlab = "Log Centered PHQ9", ylab = "Frequency")
# Add the p-value annotation
text(x = 0.4, y = 30, 
     labels = paste("Shapiro-Wilk p-value: ", p_value))

```


Conduct a paired wilcox test without exact p-value estatiom between each pair of visits
```{r}
# 1. Reshape data to wide format so we can run a paired test
##########################################################
# Filter out NAs for plotting
All_obs_na <- All_obs %>% filter(!is.na(PHQ9))
data_wide <- dcast(All_obs_na, ParticipantID ~ Visit, value.var = "PHQ9_c")

# 2. Loop over the visits to run the paired wilcox test
##########################################################

# List of visits
visits <- colnames(data_wide)[-1]

# Matrix to store the p values from the test
p_values <- matrix(NA, ncol = length(visits), nrow = length(visits), dimnames = list(visits, visits))

# loop over all pairs of visits
for (i in 1:(length(visits) - 1)) {
  for (j in (i + 1):length(visits)) {
    visit1 <- visits[i]
    visit2 <- visits[j]
    
    # Perform Wilcoxon signed-rank test paired
    test <- wilcox.test(data_wide[[visit1]], data_wide[[visit2]], 
                        paired = TRUE, 
                        exact = FALSE)
    
    # Store p-value
    p_values[i, j] <- test$p.value
  }
}

# Adjust p-values with Benjamini-Hochberg method
p_values_adjusted <- p.adjust(p_values, method = "BH")

# store adjusted p-values into a matrix
wilcox_result <- matrix(p_values_adjusted, ncol = length(visits), nrow = length(visits), dimnames = list(visits, visits))

# Print the findings from the wilcox test
wilcox_result

```

No difference in PHQ9 scores among any pairs of visits

Plot the findings
```{r}
#  PHQ9 scores between visits Raw
####################################################################
ggplot(data = All_obs_na, aes(x=Visit, y=PHQ9, fill=Visit)) +
  geom_violin(alpha = 0.5) +
  geom_jitter(position = position_jitter(seed = 1, width = 0.2)) +
  ylab("PHQ9") +
  theme_classic() +
  scale_x_discrete(limits = c("T1", "SV","T2", "T3", "PP")) 


#  Log
####################################################################
ggplot(data = All_obs_na, aes(x=Visit, y=logPHQ9, fill=Visit)) +
  geom_violin(alpha = 0.5) +
  geom_jitter(position = position_jitter(seed = 1, width = 0.2)) +
  ylab("Log PHQ9") +
  theme_classic() +
  scale_x_discrete(limits = c("T1", "SV","T2", "T3", "PP")) 

#  Log and Scaled to betweein 0 and 1
####################################################################
ggplot(data = All_obs_na, aes(x=Visit, y=PHQ9_c, fill=Visit)) +
  geom_violin(alpha = 0.5) +
  geom_jitter(position = position_jitter(seed = 1, width = 0.2)) +
  ylab("Log & Scaled PHQ9") +
  theme_classic() +
  scale_x_discrete(limits = c("T1", "SV","T2", "T3", "PP")) 



# Plot the data
ggplot(data = All_obs_na, aes(x = Visit, y = PHQ9_c, fill = Visit)) +
  geom_violin(alpha = 0.5) +
  geom_jitter(position = position_jitter(seed = 1, width = 0.2)) +
  ylab("Log & Scaled PHQ9") +
  theme_classic() +
  scale_x_discrete(limits = c("T1", "SV", "T2", "T3", "PP")) 



```


#### 1.3.2 LMM Of PHQ-9

Perinatal
```{r}
# Step 1: Filter to Alpha Power
#################################################################
Plot_data <- Spec_Meta_data %>% 
  subset(Freq_int_name == "Alpha") %>% # filter to one set of data
  group_by(ParticipantID) %>%
  #filter(n() >= 3) %>%
  ungroup()


# Step 2: Create the Model
#################################################################
LMM <- lmer (PHQ9_c ~ EGA_c +  Healthcare + Race_Black + Ethnicity_Hispanic + 
               (EGA_c|ParticipantID), Plot_data, REML=T)


sjPlot::tab_model(LMM)

# Step 3: Plot Fixed Effects of PHQ9_c
#################################################################

# Summary of Coefficients
summary_lmer <- summary(LMM)

# Merge output into new dataframe for plotting
fitted_vals <- as.matrix(as.numeric(fitted(LMM)))
EGA_c <- LMM@frame[["EGA_c"]]
ParticipantID <- LMM@frame[["ParticipantID"]]

plot_data <- data.frame(fitted_vals = fitted_vals, 
                        EGA_c = EGA_c, ParticipantID = ParticipantID)

# add in the original EGA values etc. 
merged_data <- merge(plot_data, Plot_data, by = c("ParticipantID", "EGA_c"))


# Plot Fitted values
ggplot(merged_data, aes(x=EGA_c, y=fitted_vals, col = SplitEGA_c)) +
  geom_point(size = 4) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 0.999, 1, 1.15) / 1.15, # Making values slightly different
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")) +
  geom_abline(intercept = fixef(LMM)["(Intercept)"], slope = fixef(LMM)["EGA_c"], 
              color = "red", linetype = "dashed", linewidth = 1) +
  labs(x = "EGA", y = "Adjusted PHQ-9", color = "Scaled EGA") + 
  #annotate(geom = "text", x = 0.3, y = 1, 
   #        label = paste0("p-value =", signif(summary_lmer$coefficients["EGA_c", "Pr(>|t|)"], digits = 3)),
    #       color = "black") +
  theme_classic() +
  ylim(0,1) +
  xlab("Adjusted Estimated Gestational Weeks") +
  theme(axis.text.x = element_text(family = "sans", color = "black", size = 14),
        axis.text.y = element_text(family = "sans", color = "black", size = 14),
        axis.title.x = element_text(family = "sans", color = "black", size = 14),
        axis.title.y = element_text(family = "sans", color = "black", size = 14))
```


Antenatal
```{r}
# Step 1: Filter to Alpha Power and antenatal
#################################################################
Plot_data <- Plot_data <- Spec_Meta_data %>% subset(Freq_int_name == "Alpha") %>% #filter to onee set of data
  subset(!Visit == "PP") %>% #Antenatal only
  group_by(ParticipantID) %>%
  #filter(n() >= 3) %>%
  ungroup()


# Step 2: Create the Model
#################################################################
LMM <- lmer (PHQ9_c ~ EGA_c +  Healthcare + Race_Black + Ethnicity_Hispanic + 
               (EGA_c|ParticipantID), Plot_data, REML=T)


sjPlot::tab_model(LMM)

# Step 3: Plot Fixed Effects of PHQ9_c
#################################################################

# Summary of Coefficients
summary_lmer <- summary(LMM)

# Merge output into new dataframe for plotting
fitted_vals <- as.matrix(as.numeric(fitted(LMM)))
EGA_c <- LMM@frame[["EGA_c"]]
ParticipantID <- LMM@frame[["ParticipantID"]]

plot_data <- data.frame(fitted_vals = fitted_vals, 
                        EGA_c = EGA_c, ParticipantID = ParticipantID)

# add in the original EGA values etc. 
merged_data <- merge(plot_data, Plot_data, by = c("ParticipantID", "EGA_c"))


# Plot Fitted values
ggplot(merged_data, aes(x=EGA_c, y=fitted_vals, col = SplitEGA_c)) +
  geom_point(size = 4) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 0.999, 1, 1.15) / 1.15, # Making values slightly different
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")) +
  geom_abline(intercept = fixef(LMM)["(Intercept)"], slope = fixef(LMM)["EGA_c"], 
              color = "red", linetype = "dashed", linewidth = 1) +
  labs(x = "EGA", y = "Adjusted PHQ-9", color = "Scaled EGA") + 
  #annotate(geom = "text", x = 0.3, y = 1, 
   #        label = paste0("p-value =", signif(summary_lmer$coefficients["EGA_c", "Pr(>|t|)"], digits = 3)),
    #       color = "black") +
  theme_classic() +
  ylim(0,1) +
  xlab("Adjusted Estimated Gestational Weeks") +
  theme(axis.text.x = element_text(family = "sans", color = "black", size = 14),
        axis.text.y = element_text(family = "sans", color = "black", size = 14),
        axis.title.x = element_text(family = "sans", color = "black", size = 14),
        axis.title.y = element_text(family = "sans", color = "black", size = 14))
```


#### 1.3.3 Stratification of PHQ-9 and GAD-7
normal (0-4), Mild (5-9), and Moderate/Severe (>=10). 
```{r}
# Prep the Data
MH_stratification <- All_obs %>% dplyr::select("Visit", "ParticipantID", "PHQ9", "GAD7")

# Add categories
MH_stratification <- MH_stratification %>% 
  mutate(PHQ9_category = case_when(
    PHQ9 <= 4 ~ "Normal",
    PHQ9 >= 5 & PHQ9 <= 9 ~ "Mild",
    PHQ9 >= 10 ~ "Moderate/Severe",
    is.na(PHQ9) ~ "Missing")) %>% 
  mutate(GAD7_category = case_when(
    GAD7 <= 4 ~ "Normal",
    GAD7 >= 5 & GAD7 <= 9 ~ "Mild",
    GAD7 >= 10 ~ "Moderate/Severe",
    is.na(GAD7) ~ "Missing"))

# PHQ-9
ggplot(MH_stratification, aes(x = Visit, fill = PHQ9_category)) +
  geom_bar(position = "dodge") +  
  labs(x = "Visit", y = "Count", fill = "Category") +
  theme_classic() +
  scale_fill_manual(values = c("Normal" = "darkblue", "Mild" = "orange", 
                               "Moderate/Severe" = "red4", "Missing" = "grey")) +
  theme(axis.text.x = element_text(size = 14, color = "black"),
        axis.text.y = element_text(size = 14, color = "black"),
        axis.title.x = element_text(size = 16, color = "black"),
        axis.title.y = element_text(size = 16, color = "black"),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12))  +
  scale_x_discrete(limits = c("T1", "SV","T2", "T3", "PP")) 


# GAD-7
ggplot(MH_stratification, aes(x = Visit, fill = GAD7_category)) +
  geom_bar(position = "dodge") + 
  labs(x = "Visit", y = "Count", fill = "Category") +
  theme_classic() +
  scale_fill_manual(values = c("Normal" = "darkblue", "Mild" = "orange", 
                               "Moderate/Severe" = "red4", "Missing" = "grey")) +
  theme(axis.text.x = element_text(size = 14, color = "black"),
        axis.text.y = element_text(size = 14, color = "black"),
        axis.title.x = element_text(size = 16, color = "black"),
        axis.title.y = element_text(size = 16, color = "black"),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12))  +
  scale_x_discrete(limits = c("T1", "SV","T2", "T3", "PP")) 
```



Plot category by the four main visits
```{r}
# Prep the Data
MH_stratification <- All_obs %>% dplyr::select("Visit", "ParticipantID", "PHQ9", "GAD7")

# Add categories
MH_stratification <- MH_stratification %>% 
  mutate(PHQ9_category = case_when(
    PHQ9 <= 4 ~ "Normal",
    PHQ9 >= 5 & PHQ9 <= 9 ~ "Mild",
    PHQ9 >= 10 ~ "Moderate/Severe",
    is.na(PHQ9) ~ "Missing")) %>% 
  mutate(GAD7_category = case_when(
    GAD7 <= 4 ~ "Normal",
    GAD7 >= 5 & GAD7 <= 9 ~ "Mild",
    GAD7 >= 10 ~ "Moderate/Severe",
    is.na(GAD7) ~ "Missing")) %>%
  mutate(Visit = case_when(Visit == "T1" ~ "<16",
                           Visit == "SV" ~ "20",
                           Visit == "T2" ~ "24-28",
                           Visit == "T3" ~ "36",
                           Visit == "PP" ~ "Postpartum"))

# Compute proportions within each visit
plot_data <- MH_stratification %>%
  group_by(Visit, PHQ9_category) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(Visit) %>%
  mutate(percent = n / sum(n))  # Calculate percent per visit

# Plot
ggplot(plot_data, aes(x = Visit, y = percent, fill = PHQ9_category)) +
  geom_bar(stat = "identity", position = "fill", alpha = 0.8) +  
  geom_text(aes(label = scales::percent(percent, accuracy = 1)), 
            position = position_fill(vjust = 0.5), 
            size = 3, color = "black") +  # Adjust text size & color
  labs(x = "Gestational Weeks", y = "Proportion", fill = "PHQ-9 Category") +
  theme_classic() +
  scale_fill_manual(values = c("Normal" = "dodgerblue2", "Mild" = "mediumpurple", 
                               "Moderate/Severe" = "darkorange2", "Missing" = "grey")) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +  # Format y-axis as percentage
  theme(axis.text.x = element_text(size = 14, color = "black"),
        axis.text.y = element_text(size = 14, color = "black"),
        axis.title.x = element_text(size = 16, color = "black"),
        axis.title.y = element_text(size = 16, color = "black"),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12))  +
  scale_x_discrete(limits = c("<16", "20","24-28", "36", "Postpartum"))  


# compute a Fishers exact test for proportions (instead of Chi^2 because of small sample size)
MH_stratification_test <- MH_stratification %>% filter(PHQ9_category != "Missing")
fisher.test(table(MH_stratification_test$Visit, MH_stratification_test$PHQ9_category), simulate.p.value=TRUE)

```

What percent of participants will get a 10 or higher?
```{r}
MH_stratification_mod <- MH_stratification %>% filter(PHQ9_category == "Moderate/Severe")

length(unique(MH_stratification_mod$ParticipantID))/length(unique(MH_stratification$ParticipantID))

```


Plot category by the four main visits
```{r}

# Compute proportions within each visit
plot_data <- MH_stratification %>%
  group_by(Visit, GAD7_category) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(Visit) %>%
  mutate(percent = n / sum(n))  # Calculate percent per visit

# Plot
ggplot(plot_data, aes(x = Visit, y = percent, fill = GAD7_category)) +
  geom_bar(stat = "identity", position = "fill", alpha = 0.8) +  
  geom_text(aes(label = scales::percent(percent, accuracy = 1)), 
            position = position_fill(vjust = 0.5), 
            size = 3, color = "black") +  # Adjust text size & color
  labs(x = "Gestational Weeks", y = "Proportion", fill = "GAD-7 Category") +
  theme_classic() +
  scale_fill_manual(values = c("Normal" = "dodgerblue2", "Mild" = "mediumpurple", 
                               "Moderate/Severe" = "darkorange2", "Missing" = "grey")) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +  # Format y-axis as percentage
  theme(axis.text.x = element_text(size = 14, color = "black"),
        axis.text.y = element_text(size = 14, color = "black"),
        axis.title.x = element_text(size = 16, color = "black"),
        axis.title.y = element_text(size = 16, color = "black"),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12))  +
  scale_x_discrete(limits = c("<16", "20","24-28", "36", "Postpartum"))  


# compute a Fishers exact test for proportions (instead of Chi^2 because of small sample size)
MH_stratification_test <- MH_stratification %>% filter(GAD7_category != "Missing")
fisher.test(table(MH_stratification_test$Visit, MH_stratification_test$GAD7_category), simulate.p.value=TRUE)

```


What percent of participants will get a 10 or higher?
```{r}
MH_stratification_mod <- MH_stratification %>% filter(GAD7_category == "Moderate/Severe")

length(unique(MH_stratification_mod$ParticipantID))/length(unique(MH_stratification$ParticipantID))

length(unique(MH_stratification_mod$ParticipantID))
length(unique(MH_stratification$ParticipantID))
```




### 1.4 Distribution of the Power data
```{r}
# Filter out all obs to make it easier
SM_data <- Spec_Meta_data %>% subset(!Freq_int_name == "All")

ggplot(SM_data, aes(Total_rel, fill = Freq_int_name)) + 
  geom_histogram(alpha = 0.5, bins = 40, aes(y = after_stat(density)), position = 'identity') +
  xlab("Relative Spectral Power") +
  ylab("Density") +
  labs(fill = "Wave Form") +
  theme_classic() +
  theme(axis.text.x =  element_text(family = "arial", color = "black", size =14),
        axis.text.y =  element_text(family = "arial", color = "black", size =14),
        axis.title.x =  element_text(family = "arial", color = "black", size =14),
        axis.title.y =  element_text(family = "arial", color = "black", size =14),
        legend.title = element_text(family = "arial", color = "black", size =14))
```


### 1.5 Covariates of Power data?


If we are including Age_c + Healthcare_numeric + Ethnicity_Hispanic + Race_Black + EGA_c as covariates, check how each is associated with total power

#### 1.5.1 - Age
```{r}
# Graph
########################################
ggplot(data = SM_data, aes(x = Age_c, y = Total_rel, color = Visit)) +
  geom_point() +
  geom_jitter(position = position_jitter(seed = 1, width = 0.2)) +
  ylab("Total Power") +
  xlab("Age (centered)") +
  theme_classic()  +
  theme(axis.text.x =  element_text(family = "arial", color = "black", size =14),
        axis.text.y =  element_text(family = "arial", color = "black", size =14),
        axis.title.x =  element_text(family = "arial", color = "black", size =14),
        axis.title.y =  element_text(family = "arial", color = "black", size =14),
        legend.title = element_text(family = "arial", color = "black", size =14))

# Linear Model
########################################
lm.model <- lm(PHQ9_c ~ Age_c, data = SM_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("Age (centered)") + 
  ylab("Adjusted PHQ-9") +
  theme(axis.text.x =  element_text(family = "arial", color = "black", size =14),
        axis.text.y =  element_text(family = "arial", color = "black", size =14),
        axis.title.x =  element_text(family = "arial", color = "black", size =14),
        axis.title.y =  element_text(family = "arial", color = "black", size =14))
```



#### 1.5.2 - Healthcare
```{r}

# Graph
########################################
ggplot(data = SM_data, aes(x = Healthcare, y = PHQ9_c, fill = Healthcare)) +
  geom_violin(alpha = 0.5) +
  geom_jitter(position = position_jitter(seed = 1, width = 0.2)) +
  ylab("Adjusted PHQ-9") +
  theme_classic()  +
  theme(axis.text.x =  element_text(family = "arial", color = "black", size =14),
        axis.text.y =  element_text(family = "arial", color = "black", size =14),
        axis.title.x =  element_text(family = "arial", color = "black", size =14),
        axis.title.y =  element_text(family = "arial", color = "black", size =14),
        legend.position = "none")

# Wilcox test
########################################
Healthcare_0 <- SM_data %>% filter(Healthcare == "Federal_Insurance")
Healthcare_1 <- SM_data %>% filter(Healthcare == "Private_Insurance")


wilcox.test(Healthcare_0$PHQ9_c, Healthcare_1$PHQ9_c, alternative = "two.sided",
            mu = 0, paired = FALSE, exact = NULL, correct = TRUE,
            conf.int = FALSE, conf.level = 0.95)

```




#### 1.5.3 - Ethnicity_Hispanic
```{r}
# Graph
########################################
ggplot(data = SM_data, aes(x = as.factor(Ethnicity_Hispanic), y = PHQ9_c, 
                           fill = as.factor(Ethnicity_Hispanic))) +
  geom_violin(alpha = 0.5) +
  geom_jitter(position = position_jitter(seed = 1, width = 0.2)) +
  ylab("Adjusted PHQ-9") +
  xlab("Hispanic (Y/N)") +
  theme_classic()  +
  theme(axis.text.x =  element_text(family = "arial", color = "black", size =14),
        axis.text.y =  element_text(family = "arial", color = "black", size =14),
        axis.title.x =  element_text(family = "arial", color = "black", size =14),
        axis.title.y =  element_text(family = "arial", color = "black", size =14),
        legend.position = "none")

# Wilcox test
########################################
Ethnicity_0 <- SM_data %>% filter(Ethnicity_Hispanic == 0)
Ethnicity_1 <- SM_data %>% filter(Ethnicity_Hispanic == 1)


wilcox.test(Ethnicity_0$PHQ9_c, Ethnicity_1$PHQ9_c, alternative = "two.sided",
            mu = 0, paired = FALSE, exact = NULL, correct = TRUE,
            conf.int = FALSE, conf.level = 0.95)
```


#### 1.5.4 - Race_Black
```{r}
# Graph
########################################
ggplot(data = SM_data, aes(x = as.factor(Race_Black), y = PHQ9_c, 
                           fill = as.factor(Race_Black))) +
  geom_violin(alpha = 0.5) +
  geom_jitter(position = position_jitter(seed = 1, width = 0.2)) +
  ylab("Adjusted PHQ-9") +
  xlab("Black Race") +
  theme_classic()  +
  theme(axis.text.x =  element_text(family = "arial", color = "black", size =14),
        axis.text.y =  element_text(family = "arial", color = "black", size =14),
        axis.title.x =  element_text(family = "arial", color = "black", size =14),
        axis.title.y =  element_text(family = "arial", color = "black", size =14),
        legend.position = "none")


# Wilcox test
########################################
Race_Black_0 <- SM_data %>% filter(Race_Black == 0)
Race_Black_1 <- SM_data %>% filter(Race_Black== 1)


wilcox.test(Race_Black_0$PHQ9_c, Race_Black_1$PHQ9_c, alternative = "two.sided",
            mu = 0, paired = FALSE, exact = NULL, correct = TRUE,
            conf.int = FALSE, conf.level = 0.95)
```




#### 1.5.5 - EGA
```{r}
# Graph
########################################
ggplot(data = SM_data, aes(x = EGA_c, y = PHQ9_c, color = Visit)) +
  geom_point() +
  ylab("Adjusted PHQ-9") +
  xlab("EGA (centered)") +
  theme_classic()  +
  theme(axis.text.x =  element_text(family = "arial", color = "black", size =14),
        axis.text.y =  element_text(family = "arial", color = "black", size =14),
        axis.title.x =  element_text(family = "arial", color = "black", size =14),
        axis.title.y =  element_text(family = "arial", color = "black", size =14),
        legend.title = element_text(family = "arial", color = "black", size =14))

# Linear Model
########################################
lm.model <- lm(PHQ9_c ~ EGA_c, data = SM_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("EGA (centered)") + 
  ylab("Adjusted PHQ-9") +
  theme(axis.text.x =  element_text(family = "arial", color = "black", size =14),
        axis.text.y =  element_text(family = "arial", color = "black", size =14),
        axis.title.x =  element_text(family = "arial", color = "black", size =14),
        axis.title.y =  element_text(family = "arial", color = "black", size =14))
```



#### 1.5.6 - Check for Multicolinearity
(1) Check For Multicolinearity among predictors
(2) Check if fit improves or not with removing covariates

If the ANOVA test is not signficant, this means there is no difference in fit with a simpler model compared to a complex model. Thus the more complex model (more predictors) may not be justified
```{r}
# Example Linear Model from T1
################################################################################
# Filter to visit
T1_Plot_data <- Spec_Meta_data %>% subset(Visit == "T1")
# Filter to wave forms and those with age so we can compare the same sample size
Plot_data <- T1_Plot_data %>% subset(Freq_int_name == "Theta") %>% subset(!is.na(Age_c))

# Complex Model
lm.model <- lm(PHQ9_c ~ Total_rel + Healthcare_numeric + EGA_c + Age_c + Race_Black + 
                 Ethnicity_Hispanic, data = Plot_data)

# Simplier Model (no Age)
lm.model2 <- lm(PHQ9_c ~ Total_rel + Healthcare_numeric + EGA_c + Race_Black + Ethnicity_Hispanic, data = Plot_data)

# Compare the outputs and a VIF test (<5 is better)
################################################################################
car::vif(lm.model)
summary(lm.model)
car::vif(lm.model2)
summary(lm.model2)

# Compare Model Fit
################################################################################
anova(lm.model, lm.model2)
```


## Part 2: PHQ9 Analysis 
***

### 2.1 - PHQ9 predicted by Relative Power by Visit (Linear Models)
#### 2.1.1 - First Trimester PHQ9
*** 
Relative Power as a function of CAT_DI for first trimester
```{r}
#Step 1: Prep the data
################################################################################
T1_Plot_data <- Spec_Meta_data %>% subset(Visit == "T1") %>% filter(!is.na(PHQ9))

#Relative Theta
###############################################################################
Plot_data <- T1_Plot_data %>% subset(Freq_int_name == "Theta")
lm.model <- lm(PHQ9_c ~ Total_rel + Healthcare_numeric + EGA_c + Race_Black + 
                 Ethnicity_Hispanic, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T1 Relative Theta power") + 
  ylab("Adjusted PHQ-9") +
#### this increased the axes titles and numbers
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
#### size and stroke increase size and remove border around points respectively
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")



#Relative Beta
###############################################################################
Plot_data <- T1_Plot_data %>% subset(Freq_int_name == "Beta")
lm.model <- lm(PHQ9_c ~ Total_rel + Healthcare_numeric + EGA_c + Race_Black + 
                 Ethnicity_Hispanic, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T1 Relative Beta power") + 
  ylab("Adjusted PHQ-9") +
#### this increased the axes titles and numbers
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
#### size and stroke increase size and remove border around points respectively
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")


#Relative Alpha
###############################################################################
Plot_data <- T1_Plot_data %>% subset(Freq_int_name == "Alpha")
lm.model <- lm(PHQ9_c ~ Total_rel + Healthcare_numeric + EGA_c + Race_Black + 
                 Ethnicity_Hispanic, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T1 Relative Alpha power") + 
  ylab("Adjusted PHQ-9") +
#### this increased the axes titles and numbers
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
#### size and stroke increase size and remove border around points respectively
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")


#Relative Delta
###############################################################################
Plot_data <- T1_Plot_data %>% subset(Freq_int_name == "Delta")
lm.model <- lm(PHQ9_c ~ Total_rel + Healthcare_numeric + EGA_c + Race_Black + 
                 Ethnicity_Hispanic, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T1 Relative Delta power") + 
  ylab("Adjusted PHQ-9") +
#### this increased the axes titles and numbers
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
#### size and stroke increase size and remove border around points respectively
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")

#Relative Gamma
###############################################################################
Plot_data <- T1_Plot_data %>% subset(Freq_int_name == "Gamma")
lm.model <- lm(PHQ9_c ~ Total_rel + Healthcare_numeric + EGA_c + Race_Black + 
                 Ethnicity_Hispanic, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T1 Relative Gamma power") + 
  ylab("Adjusted PHQ-9") +
#### this increased the axes titles and numbers
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
#### size and stroke increase size and remove border around points respectively
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")
```


#### 2.1.2 - 20 Week
*** 
Relative Power as a function of PHQ9 for first trimester
```{r}
#Step 1: Prep the data
################################################################################
SV_Plot_data <- Spec_Meta_data %>% subset(Visit == "SV") %>% filter(!is.na(PHQ9))

#Relative Theta
###############################################################################
Plot_data <- SV_Plot_data %>% subset(Freq_int_name == "Theta")
lm.model <- lm(PHQ9_c ~ Total_rel + Healthcare_numeric + EGA_c + Race_Black + 
                 Ethnicity_Hispanic, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("20 week Relative Theta power") + 
  ylab("Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")


#Relative Beta
###############################################################################
Plot_data <- SV_Plot_data %>% subset(Freq_int_name == "Beta")
lm.model <- lm(PHQ9_c ~ Total_rel + Healthcare_numeric + EGA_c + Race_Black + 
                 Ethnicity_Hispanic, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("20 Week Relative Beta power") + 
  ylab("Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")


#Relative Alpha
###############################################################################
Plot_data <- SV_Plot_data %>% subset(Freq_int_name == "Alpha")
lm.model <- lm(PHQ9_c ~ Total_rel + Healthcare_numeric + EGA_c + Race_Black + 
                 Ethnicity_Hispanic, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("20 Week Relative Alpha power") + 
  ylab("Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")

#Relative Delta
###############################################################################
Plot_data <- SV_Plot_data %>% subset(Freq_int_name == "Delta")
lm.model <- lm(PHQ9_c ~ Total_rel + Healthcare_numeric + EGA_c + Race_Black + 
                 Ethnicity_Hispanic, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("20 Week Relative Delta power") + 
  ylab("Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")

#Relative Gamma
###############################################################################
Plot_data <- SV_Plot_data %>% subset(Freq_int_name == "Gamma")
lm.model <- lm(PHQ9_c ~ Total_rel + Healthcare_numeric + EGA_c + Race_Black + 
                 Ethnicity_Hispanic, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("20 Week Relative Gamma power") + 
  ylab("Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")
```





#### 2.1.3 - Second Trimester PHQ9_c
*** 
```{r}
#Step 1: Prep the data
################################################################################
T2_Plot_data <- Spec_Meta_data %>% subset(Visit == "T2") %>% filter(!is.na(PHQ9))

#Relative Theta
###############################################################################
Plot_data <- T2_Plot_data %>% subset(Freq_int_name == "Theta")
lm.model <- lm(PHQ9_c ~ Total_rel + Healthcare_numeric + EGA_c + Race_Black + 
                 Ethnicity_Hispanic, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T2 Relative Theta power") + 
  ylab("Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")


#Relative Beta
###############################################################################
Plot_data <- T2_Plot_data %>% subset(Freq_int_name == "Beta")
lm.model <- lm(PHQ9_c ~ Total_rel + Healthcare_numeric + EGA_c + Race_Black + 
                 Ethnicity_Hispanic, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T2 Relative Beta power") + 
  ylab("Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")


#Relative Alpha
###############################################################################
Plot_data <- T2_Plot_data %>% subset(Freq_int_name == "Alpha")
lm.model <- lm(PHQ9_c ~ Total_rel + Healthcare_numeric + EGA_c + Race_Black + 
                 Ethnicity_Hispanic, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T2 Relative Alpha power") + 
  ylab("Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")


#Relative Delta
###############################################################################
Plot_data <- T2_Plot_data %>% subset(Freq_int_name == "Delta")
lm.model <- lm(PHQ9_c ~ Total_rel + Healthcare_numeric + EGA_c + Race_Black + 
                 Ethnicity_Hispanic, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T2 Relative Delta power") + 
  ylab("Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")

#Relative Gamma
###############################################################################
Plot_data <- T2_Plot_data %>% subset(Freq_int_name == "Gamma")
lm.model <- lm(PHQ9_c ~ Total_rel + Healthcare_numeric + EGA_c + Race_Black + 
                 Ethnicity_Hispanic, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T2 Relative Gamma power") + 
  ylab("Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")
```


#### 2.1.4 - Third Trimester PHQ9_c
```{r}
#Step 1: Prep the data
################################################################################
T3_Plot_data <- Spec_Meta_data %>% subset(Visit == "T3") %>% filter(!is.na(PHQ9))

#Relative Theta
###############################################################################
Plot_data <- T3_Plot_data %>% subset(Freq_int_name == "Theta")
lm.model <- lm(PHQ9_c ~ Total_rel + Healthcare_numeric + EGA_c + Race_Black + 
                 Ethnicity_Hispanic, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T3 Relative Theta power") + 
  ylab("Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")


#Relative Beta
###############################################################################
Plot_data <- T3_Plot_data %>% subset(Freq_int_name == "Beta")
lm.model <- lm(PHQ9_c ~ Total_rel + Healthcare_numeric + EGA_c + Race_Black + 
                 Ethnicity_Hispanic, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T3 Relative Beta power") + 
  ylab("Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")


#Relative Alpha
###############################################################################
Plot_data <- T3_Plot_data %>% subset(Freq_int_name == "Alpha")
lm.model <- lm(PHQ9_c ~ Total_rel + Healthcare_numeric + EGA_c + Race_Black + 
                 Ethnicity_Hispanic, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T3 Relative Alpha power") + 
  ylab("Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")


#Relative Delta
###############################################################################
Plot_data <- T3_Plot_data %>% subset(Freq_int_name == "Delta")
lm.model <- lm(PHQ9_c ~ Total_rel + Healthcare_numeric + EGA_c + Race_Black + 
                 Ethnicity_Hispanic, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T3 Relative Delta power") + 
  ylab("Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")

#Relative Gamma
###############################################################################
Plot_data <- T3_Plot_data %>% subset(Freq_int_name == "Gamma")
lm.model <- lm(PHQ9_c ~ Total_rel + Healthcare_numeric + EGA_c + Race_Black + 
                 Ethnicity_Hispanic, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T3 Relative Gamma power") + 
  ylab("Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")
```


#### 2.1.5 - Post-partum PHQ9_c
```{r}
#Step 1: Prep the data
################################################################################
PP_Plot_data <- Spec_Meta_data %>% subset(Visit == "PP")

#Relative Theta
###############################################################################
Plot_data <- PP_Plot_data %>% subset(Freq_int_name == "Theta")
lm.model <- lm(PHQ9_c ~ Total_rel + Healthcare_numeric + EGA_c + Race_Black + 
                 Ethnicity_Hispanic, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("PP Relative Theta power") + 
  ylab("Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")


#Relative Beta
###############################################################################
Plot_data <- PP_Plot_data %>% subset(Freq_int_name == "Beta")
lm.model <- lm(PHQ9_c ~ Total_rel + Healthcare_numeric + EGA_c + Race_Black + 
                 Ethnicity_Hispanic, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("PP Relative Beta power") + 
  ylab("Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")


#Relative Alpha
###############################################################################
Plot_data <- PP_Plot_data %>% subset(Freq_int_name == "Alpha")
lm.model <- lm(PHQ9_c ~ Total_rel + Healthcare_numeric + EGA_c + Race_Black + 
                 Ethnicity_Hispanic, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("PP Relative Alpha power") + 
  ylab("Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")

#Relative Delta
###############################################################################
Plot_data <- PP_Plot_data %>% subset(Freq_int_name == "Delta")
lm.model <- lm(PHQ9_c ~ Total_rel + Healthcare_numeric + EGA_c + Race_Black + 
                 Ethnicity_Hispanic, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("Postpartum Relative Delta power") + 
  ylab("Scaled PHQ9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")

#Relative Gamma
###############################################################################
Plot_data <- PP_Plot_data %>% subset(Freq_int_name == "Gamma")
lm.model <- lm(PHQ9_c ~ Total_rel + Healthcare_numeric + EGA_c + Race_Black + 
                 Ethnicity_Hispanic, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("PP Relative Gamma power") + 
  ylab("Scaled PHQ9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")
```






### 2.2 - PHQ9_c/Relative Power (Linear Mixed Models)

Filter to participants with 3 or more visits for Linear Mixed Effect Models


#### 2.2.1 - Alpha wave (perinatal)
For this linear mixed model, im allowing Total_rel slope to vary participant to participant
```{r}
# Step 1: Filter to Alpha Power
#################################################################
Plot_data <- Spec_Meta_data %>% 
  subset(Freq_int_name == "Alpha") %>%
  group_by(ParticipantID) %>%
  filter(n() >= 3) %>%
  ungroup()


# Step 2: Create the Model
#################################################################
LMM <- lmer (PHQ9_c ~ Total_rel +  Healthcare + 
               EGA_c+ + Race_Black + Ethnicity_Hispanic + 
               (Total_rel|ParticipantID), Plot_data, REML=T)


sjPlot::tab_model(LMM)

# Step 3: Plot Fixed Effects of PHQ9_c
#################################################################

# Summary of Coefficients
summary_lmer <- summary(LMM)

# Merge output into new dataframe for plotting
fitted_vals <- as.matrix(as.numeric(fitted(LMM)))
total_rel <- LMM@frame[["Total_rel"]]
EGA_c <- LMM@frame[["EGA_c"]]
ParticipantID <- LMM@frame[["ParticipantID"]]

plot_data <- data.frame(fitted_vals = fitted_vals, 
                        Total_rel = total_rel, EGA_c = EGA_c, ParticipantID = ParticipantID)

# add in the original EGA values etc. 
merged_data <- merge(plot_data, Plot_data, by = c("ParticipantID", "EGA_c", "Total_rel"))


# Plot Fitted values
ggplot(merged_data, aes(Total_rel, fitted_vals, col = SplitEGA_c)) +
  geom_point(size = 1.5) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 0.999, 1, 1.15) / 1.15, # Making values slightly different
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  geom_abline(intercept = fixef(LMM)["(Intercept)"], slope = fixef(LMM)["Total_rel"], 
              color = "red", linetype = "dashed", linewidth = 1) +
  labs(x = "Relative Alpha Power", y = "Adjusted PHQ-9", color = "Scaled EGA") + 
  annotate(geom = "text", x = 0.3, y = 1, 
           label = paste0("p-value =", signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits = 3)),
           color = "black") +
  theme_classic() +
  theme(axis.text.x = element_text(family = "sans", color = "black", size = 14),
        axis.text.y = element_text(family = "sans", color = "black", size = 14),
        axis.title.x = element_text(family = "sans", color = "black", size = 14),
        axis.title.y = element_text(family = "sans", color = "black", size = 14))
```





#### 2.2.2 - Alpha wave (antenatal)
For this linear mixed model, im allowing Total_rel slope to vary participant to participant
```{r}
# Step 1: Filter to Alpha Power
#################################################################
Plot_data <- Spec_Meta_data %>% subset(Freq_int_name == "Alpha") %>% subset(!Visit == "PP") %>%
  group_by(ParticipantID) %>%
  filter(n() >= 3) %>%
  ungroup()


# Step 2: Create the Model
#################################################################
LMM <- lmer (PHQ9_c ~ Total_rel +  Healthcare + 
               EGA_c+ + Race_Black + Ethnicity_Hispanic + 
               (Total_rel|ParticipantID), Plot_data, REML=T)

sjPlot::tab_model(LMM)

# Step 3: Plot Fixed Effects of PHQ9_c
#################################################################

# Summary of Coefficients
summary_lmer <- summary(LMM)

# Merge output into new dataframe for plotting
fitted_vals <- as.matrix(as.numeric(fitted(LMM)))
total_rel <- LMM@frame[["Total_rel"]]
EGA_c <- LMM@frame[["EGA_c"]]
ParticipantID <- LMM@frame[["ParticipantID"]]

plot_data <- data.frame(fitted_vals = fitted_vals, 
                        Total_rel = total_rel, EGA_c = EGA_c, ParticipantID = ParticipantID)

# add in the original EGA values etc. 
merged_data <- merge(plot_data, Plot_data, by = c("ParticipantID", "EGA_c", "Total_rel"))


# Plot Fitted values
ggplot(merged_data, aes(Total_rel, fitted_vals, col = SplitEGA_c)) +
  geom_point(size = 1.5) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 0.999, 1, 1.15) / 1.15, # Making values slightly different
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  geom_abline(intercept = fixef(LMM)["(Intercept)"], slope = fixef(LMM)["Total_rel"], 
              color = "red", linetype = "dashed", linewidth = 1) +
  labs(x = "Relative Alpha Power", y = "Adjusted PHQ-9", color = "Scaled EGA") + 
  annotate(geom = "text", x = 0.3, y = 1, 
           label = paste0("p-value =", signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits = 3)),
           color = "black") +
  theme_classic() +
  theme(axis.text.x = element_text(family = "sans", color = "black", size = 14),
        axis.text.y = element_text(family = "sans", color = "black", size = 14),
        axis.title.x = element_text(family = "sans", color = "black", size = 14),
        axis.title.y = element_text(family = "sans", color = "black", size = 14))
```


#### 2.2.3 - Beta wave (perinatal)
For this linear mixed model, im allowing Total_rel slope to vary participant to participant
```{r}
# Step 1: Filter to Beta Power
#################################################################
Plot_data <- Spec_Meta_data %>% subset(Freq_int_name == "Beta") %>%
  group_by(ParticipantID) %>%
  filter(n() >= 3) %>%
  ungroup()


# Step 2: Create the Model
#################################################################
LMM <- lmer (PHQ9_c ~ Total_rel +  Healthcare + 
               EGA_c+ + Race_Black + Ethnicity_Hispanic + 
               (Total_rel|ParticipantID), Plot_data, REML=T)

sjPlot::tab_model(LMM)

# Step 3: Plot Fixed Effects of PHQ9_c
#################################################################

# Summary of Coefficients
summary_lmer <- summary(LMM)

# Merge output into new dataframe for plotting
fitted_vals <- as.matrix(as.numeric(fitted(LMM)))
total_rel <- LMM@frame[["Total_rel"]]
EGA_c <- LMM@frame[["EGA_c"]]
ParticipantID <- LMM@frame[["ParticipantID"]]

plot_data <- data.frame(fitted_vals = fitted_vals, 
                        Total_rel = total_rel, EGA_c = EGA_c, ParticipantID = ParticipantID)

# add in the original EGA values etc. 
merged_data <- merge(plot_data, Plot_data, by = c("ParticipantID", "EGA_c", "Total_rel"))


# Plot Fitted values
ggplot(merged_data, aes(Total_rel, fitted_vals, col = SplitEGA_c)) +
  geom_point(size = 1.5) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 0.999, 1, 1.15) / 1.15, # Making values slightly different
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  geom_abline(intercept = fixef(LMM)["(Intercept)"], slope = fixef(LMM)["Total_rel"], 
              color = "red", linetype = "dashed", linewidth = 1) +
  labs(x = "Relative Beta Power", y = "Adjusted PHQ-9", color = "Scaled EGA") + 
  annotate(geom = "text", x = 0.3, y = 1, 
           label = paste0("p-value =", signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits = 3)),
           color = "black") +
  theme_classic() +
  theme(axis.text.x = element_text(family = "sans", color = "black", size = 14),
        axis.text.y = element_text(family = "sans", color = "black", size = 14),
        axis.title.x = element_text(family = "sans", color = "black", size = 14),
        axis.title.y = element_text(family = "sans", color = "black", size = 14))
```




#### 2.2.4 - Beta wave (antenatal)
For this linear mixed model, im allowing Total_rel slope to vary participant to participant
```{r}
# Step 1: Filter to Alpha Power
#################################################################
Plot_data <- Spec_Meta_data %>% subset(Freq_int_name == "Beta") %>% subset(!Visit == "PP") %>%
  group_by(ParticipantID) %>%
  filter(n() >= 3) %>%
  ungroup()


# Step 2: Create the Model
#################################################################
LMM <- lmer (PHQ9_c ~ Total_rel +  Healthcare + 
               EGA_c+ + Race_Black + Ethnicity_Hispanic + 
               (Total_rel|ParticipantID), Plot_data, REML=T)

sjPlot::tab_model(LMM)

# Step 3: Plot Fixed Effects of PHQ9_c
#################################################################

# Summary of Coefficients
summary_lmer <- summary(LMM)

# Merge output into new dataframe for plotting
fitted_vals <- as.matrix(as.numeric(fitted(LMM)))
total_rel <- LMM@frame[["Total_rel"]]
EGA_c <- LMM@frame[["EGA_c"]]
ParticipantID <- LMM@frame[["ParticipantID"]]

plot_data <- data.frame(fitted_vals = fitted_vals, 
                        Total_rel = total_rel, EGA_c = EGA_c, ParticipantID = ParticipantID)

# add in the original EGA values etc. 
merged_data <- merge(plot_data, Plot_data, by = c("ParticipantID", "EGA_c", "Total_rel"))


# Plot Fitted values
ggplot(merged_data, aes(Total_rel, fitted_vals, col = SplitEGA_c)) +
  geom_point(size = 1.5) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 0.999, 1, 1.15) / 1.15, # Making values slightly different
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  geom_abline(intercept = fixef(LMM)["(Intercept)"], slope = fixef(LMM)["Total_rel"], 
              color = "red", linetype = "dashed", linewidth = 1) +
  labs(x = "Relative Beta Power", y = "Adjusted PHQ-9", color = "Scaled EGA") + 
  annotate(geom = "text", x = 0.3, y = 1, 
           label = paste0("p-value =", signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits = 3)),
           color = "black") +
  theme_classic() +
  theme(axis.text.x = element_text(family = "sans", color = "black", size = 14),
        axis.text.y = element_text(family = "sans", color = "black", size = 14),
        axis.title.x = element_text(family = "sans", color = "black", size = 14),
        axis.title.y = element_text(family = "sans", color = "black", size = 14))
```




#### 2.2.5 - Theta wave (perinatal)
For this linear mixed model, im allowing Total_rel slope to vary participant to participant
```{r}
# Step 1: Filter to Alpha Power
#################################################################
Plot_data <- Spec_Meta_data %>% subset(Freq_int_name == "Theta") %>%
  group_by(ParticipantID) %>%
  filter(n() >= 3) %>%
  ungroup()


# Step 2: Create the Model
#################################################################
LMM <- lmer (PHQ9_c ~ Total_rel +  Healthcare + 
               EGA_c+ + Race_Black + Ethnicity_Hispanic + 
               (Total_rel|ParticipantID), Plot_data, REML=T)

sjPlot::tab_model(LMM)

# Step 3: Plot Fixed Effects of PHQ9_c
#################################################################

# Summary of Coefficients
summary_lmer <- summary(LMM)

# Merge output into new dataframe for plotting
fitted_vals <- as.matrix(as.numeric(fitted(LMM)))
total_rel <- LMM@frame[["Total_rel"]]
EGA_c <- LMM@frame[["EGA_c"]]
ParticipantID <- LMM@frame[["ParticipantID"]]

plot_data <- data.frame(fitted_vals = fitted_vals, 
                        Total_rel = total_rel, EGA_c = EGA_c, ParticipantID = ParticipantID)

# add in the original EGA values etc. 
merged_data <- merge(plot_data, Plot_data, by = c("ParticipantID", "EGA_c", "Total_rel"))


# Plot Fitted values
ggplot(merged_data, aes(Total_rel, fitted_vals, col = SplitEGA_c)) +
  geom_point(size = 1.5) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 0.999, 1, 1.15) / 1.15, # Making values slightly different
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  geom_abline(intercept = fixef(LMM)["(Intercept)"], slope = fixef(LMM)["Total_rel"], 
              color = "red", linetype = "dashed", linewidth = 1) +
  labs(x = "Relative Theta Power", y = "Adjusted PHQ-9", color = "Scaled EGA") + 
  annotate(geom = "text", x = 0.2, y = 1, 
           label = paste0("p-value =", signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits = 3)),
           color = "black") +
  theme_classic() +
  theme(axis.text.x = element_text(family = "sans", color = "black", size = 14),
        axis.text.y = element_text(family = "sans", color = "black", size = 14),
        axis.title.x = element_text(family = "sans", color = "black", size = 14),
        axis.title.y = element_text(family = "sans", color = "black", size = 14))
```





####  2.2.6 - Theta wave (antenatal)
For this linear mixed model, im allowing Total_rel slope to vary participant to participant
```{r}
# Step 1: Filter to Alpha Power
#################################################################
Plot_data <- Spec_Meta_data %>% subset(Freq_int_name == "Theta") %>% subset(!Visit == "PP") %>%
  group_by(ParticipantID) %>%
  filter(n() >= 3) %>%
  ungroup()


# Step 2: Create the Model
#################################################################
LMM <- lmer (PHQ9_c ~ Total_rel +  Healthcare + 
               EGA_c+ + Race_Black + Ethnicity_Hispanic + 
               (Total_rel|ParticipantID), Plot_data, REML=T)

sjPlot::tab_model(LMM)

# Step 3: Plot Fixed Effects of PHQ9_c
#################################################################

# Summary of Coefficients
summary_lmer <- summary(LMM)

# Merge output into new dataframe for plotting
fitted_vals <- as.matrix(as.numeric(fitted(LMM)))
total_rel <- LMM@frame[["Total_rel"]]
EGA_c <- LMM@frame[["EGA_c"]]
ParticipantID <- LMM@frame[["ParticipantID"]]

plot_data <- data.frame(fitted_vals = fitted_vals, 
                        Total_rel = total_rel, EGA_c = EGA_c, ParticipantID = ParticipantID)

# add in the original EGA values etc. 
merged_data <- merge(plot_data, Plot_data, by = c("ParticipantID", "EGA_c", "Total_rel"))


# Plot Fitted values
ggplot(merged_data, aes(Total_rel, fitted_vals, col = SplitEGA_c)) +
  geom_point(size = 1.5) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 0.999, 1, 1.15) / 1.15, # Making values slightly different
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  geom_abline(intercept = fixef(LMM)["(Intercept)"], slope = fixef(LMM)["Total_rel"], 
              color = "red", linetype = "dashed", linewidth = 1) +
  labs(x = "Relative Theta Power", y = "Adjusted PHQ-9", color = "Scaled EGA") + 
  annotate(geom = "text", x = 0.2, y = 1, 
           label = paste0("p-value =", signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits = 3)),
           color = "black") +
  theme_classic() +
  theme(axis.text.x = element_text(family = "sans", color = "black", size = 14),
        axis.text.y = element_text(family = "sans", color = "black", size = 14),
        axis.title.x = element_text(family = "sans", color = "black", size = 14),
        axis.title.y = element_text(family = "sans", color = "black", size = 14))
```






#### 2.2.7 - Delta wave (perinatal)
For this linear mixed model, im allowing Total_rel slope to vary participant to participant
```{r}
# Step 1: Filter to Alpha Power
#################################################################
Plot_data <- Spec_Meta_data %>% subset(Freq_int_name == "Delta") %>%
  group_by(ParticipantID) %>%
  filter(n() >= 3) %>%
  ungroup()


# Step 2: Create the Model
#################################################################
LMM <- lmer (PHQ9_c ~ Total_rel +  Healthcare + 
               EGA_c+ + Race_Black + Ethnicity_Hispanic + 
               (Total_rel|ParticipantID), Plot_data, REML=T)

sjPlot::tab_model(LMM)

# Step 3: Plot Fixed Effects of PHQ9_c
#################################################################

# Summary of Coefficients
summary_lmer <- summary(LMM)

# Merge output into new dataframe for plotting
fitted_vals <- as.matrix(as.numeric(fitted(LMM)))
total_rel <- LMM@frame[["Total_rel"]]
EGA_c <- LMM@frame[["EGA_c"]]
ParticipantID <- LMM@frame[["ParticipantID"]]

plot_data <- data.frame(fitted_vals = fitted_vals, 
                        Total_rel = total_rel, EGA_c = EGA_c, ParticipantID = ParticipantID)

# add in the original EGA values etc. 
merged_data <- merge(plot_data, Plot_data, by = c("ParticipantID", "EGA_c", "Total_rel"))


# Plot Fitted values
ggplot(merged_data, aes(Total_rel, fitted_vals, col = SplitEGA_c)) +
  geom_point(size = 1.5) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 0.999, 1, 1.15) / 1.15, # Making values slightly different
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  geom_abline(intercept = fixef(LMM)["(Intercept)"], slope = fixef(LMM)["Total_rel"], 
              color = "red", linetype = "dashed", linewidth = 1) +
  labs(x = "Relative Delta Power", y = "Adjusted PHQ-9", color = "Scaled EGA") + 
  annotate(geom = "text", x = 0.3, y = 1, 
           label = paste0("p-value =", signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits = 3)),
           color = "black") +
  theme_classic() +
  theme(axis.text.x = element_text(family = "sans", color = "black", size = 14),
        axis.text.y = element_text(family = "sans", color = "black", size = 14),
        axis.title.x = element_text(family = "sans", color = "black", size = 14),
        axis.title.y = element_text(family = "sans", color = "black", size = 14))
```



#### 2.2.8 - Delta wave (antenatal)
For this linear mixed model, im allowing Total_rel slope to vary participant to participant
```{r}
# Step 1: Filter to Alpha Power
#################################################################
Plot_data <- Spec_Meta_data %>% subset(Freq_int_name == "Delta") %>% subset(!Visit == "PP") %>%
  group_by(ParticipantID) %>%
  filter(n() >= 3) %>%
  ungroup()


# Step 2: Create the Model
#################################################################
LMM <- lmer (PHQ9_c ~ Total_rel +  Healthcare + 
               EGA_c+ + Race_Black + Ethnicity_Hispanic + 
               (Total_rel|ParticipantID), Plot_data, REML=T)

sjPlot::tab_model(LMM)

# Step 3: Plot Fixed Effects of PHQ9_c
#################################################################

# Summary of Coefficients
summary_lmer <- summary(LMM)

# Merge output into new dataframe for plotting
fitted_vals <- as.matrix(as.numeric(fitted(LMM)))
total_rel <- LMM@frame[["Total_rel"]]
EGA_c <- LMM@frame[["EGA_c"]]
ParticipantID <- LMM@frame[["ParticipantID"]]

plot_data <- data.frame(fitted_vals = fitted_vals, 
                        Total_rel = total_rel, EGA_c = EGA_c, ParticipantID = ParticipantID)

# add in the original EGA values etc. 
merged_data <- merge(plot_data, Plot_data, by = c("ParticipantID", "EGA_c", "Total_rel"))


# Plot Fitted values
ggplot(merged_data, aes(Total_rel, fitted_vals, col = SplitEGA_c)) +
  geom_point(size = 1.5) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 0.999, 1, 1.15) / 1.15, # Making values slightly different
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  geom_abline(intercept = fixef(LMM)["(Intercept)"], slope = fixef(LMM)["Total_rel"], 
              color = "red", linetype = "dashed", linewidth = 1) +
  labs(x = "Relative Delta Power", y = "Adjusted PHQ-9", color = "Scaled EGA") + 
  annotate(geom = "text", x = 0.3, y = 1, 
           label = paste0("p-value =", signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits = 3)),
           color = "black") +
  theme_classic() +
  theme(axis.text.x = element_text(family = "sans", color = "black", size = 14),
        axis.text.y = element_text(family = "sans", color = "black", size = 14),
        axis.title.x = element_text(family = "sans", color = "black", size = 14),
        axis.title.y = element_text(family = "sans", color = "black", size = 14))
```



#### 2.2.9 - Gamma wave (perinatal)
For this linear mixed model, im allowing Total_rel slope to vary participant to participant
```{r}
# Step 1: Filter to Alpha Power
#################################################################
Plot_data <- Spec_Meta_data %>% subset(Freq_int_name == "Gamma") %>%
  group_by(ParticipantID) %>%
  filter(n() >= 3) %>%
  ungroup()


# Step 2: Create the Model
#################################################################
LMM <- lmer (PHQ9_c ~ Total_rel +  Healthcare + 
               EGA_c+ + Race_Black + Ethnicity_Hispanic + 
               (Total_rel|ParticipantID), Plot_data, REML=T)

sjPlot::tab_model(LMM)

# Step 3: Plot Fixed Effects of PHQ9_c
#################################################################

# Summary of Coefficients
summary_lmer <- summary(LMM)

# Merge output into new dataframe for plotting
fitted_vals <- as.matrix(as.numeric(fitted(LMM)))
total_rel <- LMM@frame[["Total_rel"]]
EGA_c <- LMM@frame[["EGA_c"]]
ParticipantID <- LMM@frame[["ParticipantID"]]

plot_data <- data.frame(fitted_vals = fitted_vals, 
                        Total_rel = total_rel, EGA_c = EGA_c, ParticipantID = ParticipantID)

# add in the original EGA values etc. 
merged_data <- merge(plot_data, Plot_data, by = c("ParticipantID", "EGA_c", "Total_rel"))


# Plot Fitted values
ggplot(merged_data, aes(Total_rel, fitted_vals, col = SplitEGA_c)) +
  geom_point(size = 1.5) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 0.999, 1, 1.15) / 1.15, # Making values slightly different
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  geom_abline(intercept = fixef(LMM)["(Intercept)"], slope = fixef(LMM)["Total_rel"], 
              color = "red", linetype = "dashed", linewidth = 1) +
  labs(x = "Relative Gamma Power", y = "Adjusted PHQ-9", color = "Scaled EGA") + 
  annotate(geom = "text", x = 0.1, y = 1, 
           label = paste0("p-value =", signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits = 3)),
           color = "black") +
  theme_classic() +
  theme(axis.text.x = element_text(family = "sans", color = "black", size = 14),
        axis.text.y = element_text(family = "sans", color = "black", size = 14),
        axis.title.x = element_text(family = "sans", color = "black", size = 14),
        axis.title.y = element_text(family = "sans", color = "black", size = 14))
```


#### 2.2.10 - Gamma wave (antenatal)
For this linear mixed model, im allowing Total_rel slope to vary participant to participant
```{r}
# Step 1: Filter to Alpha Power
#################################################################
Plot_data <- Spec_Meta_data %>% subset(Freq_int_name == "Gamma") %>% subset(!Visit == "PP") %>%
  group_by(ParticipantID) %>%
  filter(n() >= 3) %>%
  ungroup()


# Step 2: Create the Model
#################################################################
LMM <- lmer (PHQ9_c ~ Total_rel +  Healthcare + 
               EGA_c+ + Race_Black + Ethnicity_Hispanic + 
               (Total_rel|ParticipantID), Plot_data, REML=T)

sjPlot::tab_model(LMM)

# Step 3: Plot Fixed Effects of PHQ9_c
#################################################################

# Summary of Coefficients
summary_lmer <- summary(LMM)

# Merge output into new dataframe for plotting
fitted_vals <- as.matrix(as.numeric(fitted(LMM)))
total_rel <- LMM@frame[["Total_rel"]]
EGA_c <- LMM@frame[["EGA_c"]]
ParticipantID <- LMM@frame[["ParticipantID"]]

plot_data <- data.frame(fitted_vals = fitted_vals, 
                        Total_rel = total_rel, EGA_c = EGA_c, ParticipantID = ParticipantID)

# add in the original EGA values etc. 
merged_data <- merge(plot_data, Plot_data, by = c("ParticipantID", "EGA_c", "Total_rel"))


# Plot Fitted values
ggplot(merged_data, aes(Total_rel, fitted_vals, col = SplitEGA_c)) +
  geom_point(size = 1.5) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 0.999, 1, 1.15) / 1.15, # Making values slightly different
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  geom_abline(intercept = fixef(LMM)["(Intercept)"], slope = fixef(LMM)["Total_rel"], 
              color = "red", linetype = "dashed", linewidth = 1) +
  labs(x = "Relative Gamma Power", y = "Adjusted PHQ-9", color = "Scaled EGA") + 
  annotate(geom = "text", x = 0.1, y = 1, 
           label = paste0("p-value =", signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits = 3)),
           color = "black") +
  theme_classic() +
  theme(axis.text.x = element_text(family = "sans", color = "black", size = 14),
        axis.text.y = element_text(family = "sans", color = "black", size = 14),
        axis.title.x = element_text(family = "sans", color = "black", size = 14),
        axis.title.y = element_text(family = "sans", color = "black", size = 14))
```


### 2.3 - Predict T3 PHQ9 from T1 Waves

Try predicting T3 mental health scores from T1 wave forms

#### 2.3.1 - Alpha Waves
```{r}
# Make a dataframe with the summarized data in it
#################################################

# Wave change
Wavechange_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Alpha") %>%
  filter(Visit == "T1") %>%
  dplyr::select(ParticipantID,Visit,Freq_int_name,Total_rel)

# add in PHQ9 scores at T3
T3_phq9 <-  Spec_Meta_data %>%
  subset(Visit == "T3") %>%
  dplyr::select(ParticipantID, PHQ9_c, 
                Healthcare_numeric, Race_Black, 
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wavechange_data$ParticipantID) %>%
  unique()

# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wavechange_data, T3_phq9, by = "ParticipantID")


# Linear Model
#################################################
lm.model <- lm(PHQ9_c~ Total_rel+Healthcare_numeric+Race_Black+Ethnicity_Hispanic, 
            data = Plot_data)
summary(lm.model)

ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T1 Alpha Relative Power predicts T3 PHQ9") + 
  ylab("36 GWs Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")
```


#### 2.3.2 - Delta Waves
```{r}
# Make a dataframe with the summarized data in it
#################################################

# Wave change
Wavechange_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Delta") %>%
  filter(Visit == "T1") %>%
  dplyr::select(ParticipantID,Visit,Freq_int_name,Total_rel)

# add in PHQ9 scores at T3
T3_phq9 <-  Spec_Meta_data %>%
  subset(Visit == "T3") %>%
  dplyr::select(ParticipantID, PHQ9_c, 
                Healthcare_numeric, Race_Black, 
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wavechange_data$ParticipantID) %>%
  unique()

# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wavechange_data, T3_phq9, by = "ParticipantID")


# Linear Model
#################################################
lm.model <- lm(PHQ9_c~ Total_rel+Healthcare_numeric+Race_Black+Ethnicity_Hispanic, 
            data = Plot_data)
summary(lm.model)

ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("<16 GWs Relative Delta Power") + 
  ylab("36 GWs Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")
```




#### 2.3.3 - Theta Waves
```{r}
# Make a dataframe with the summarized data in it
#################################################

# Wave change
Wavechange_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Alpha") %>%
  filter(Visit == "T1") %>%
  dplyr::select(ParticipantID,Visit,Freq_int_name,Total_rel)

# add in PHQ9 scores at T3
T3_phq9 <-  Spec_Meta_data %>%
  subset(Visit == "T3") %>%
  dplyr::select(ParticipantID, PHQ9_c, 
                Healthcare_numeric, Race_Black, 
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wavechange_data$ParticipantID) %>%
  unique()

# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wavechange_data, T3_phq9, by = "ParticipantID")


# Linear Model
#################################################
lm.model <- lm(PHQ9_c~ Total_rel+Healthcare_numeric+Race_Black+Ethnicity_Hispanic, 
            data = Plot_data)
summary(lm.model)

ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T1 Alpha Relative Power predicts T3 PHQ9") + 
  ylab("36 GWs Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")

```




#### 2.3.4 - Beta Waves
```{r}
# Make a dataframe with the summarized data in it
#################################################

# Wave change
Wavechange_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Beta") %>%
  filter(Visit == "T1") %>%
  dplyr::select(ParticipantID,Visit,Freq_int_name,Total_rel)

# add in PHQ9 scores at T3
T3_phq9 <-  Spec_Meta_data %>%
  subset(Visit == "T3") %>%
  dplyr::select(ParticipantID, PHQ9_c, 
                Healthcare_numeric, Race_Black, 
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wavechange_data$ParticipantID) %>%
  unique()

# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wavechange_data, T3_phq9, by = "ParticipantID")


# Linear Model
#################################################
lm.model <- lm(PHQ9_c~ Total_rel+Healthcare_numeric+Race_Black+Ethnicity_Hispanic, 
            data = Plot_data)
summary(lm.model)

ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T1 Beta Relative Power predicts T3 PHQ9") + 
  ylab("36 GWs Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")

```









#### 2.3.5 - Gamma Waves
```{r}
# Make a dataframe with the summarized data in it
#################################################

# Wave change
Wavechange_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Gamma") %>%
  filter(Visit == "T1") %>%
  dplyr::select(ParticipantID,Visit,Freq_int_name,Total_rel)

# add in PHQ9 scores at T3
T3_phq9 <-  Spec_Meta_data %>%
  subset(Visit == "T3") %>%
  dplyr::select(ParticipantID, PHQ9_c, 
                Healthcare_numeric, Race_Black, 
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wavechange_data$ParticipantID) %>%
  unique()

# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wavechange_data, T3_phq9, by = "ParticipantID")


# Linear Model
#################################################
lm.model <- lm(PHQ9_c~ Total_rel+Healthcare_numeric+Race_Black+Ethnicity_Hispanic, 
            data = Plot_data)
summary(lm.model)

ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T1 Alpha Relative Power predicts T3 PHQ9") + 
  ylab("36 GWs Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")

```






### 2.4 - Predict PP PHQ9 from T1 Waves

Try predicting PP mental health scores from T1 wave forms

#### 2.4.1 - Alpha Waves
```{r}
# Make a dataframe with the summarized data in it
#################################################

# Wave change
Wavechange_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Alpha") %>%
  filter(Visit == "T1") %>%
  dplyr::select(ParticipantID,Visit,Freq_int_name,Total_rel)

# add in PHQ9 scores at PP
PP_phq9 <-  Spec_Meta_data %>%
  subset(Visit == "PP") %>%
  dplyr::select(ParticipantID, PHQ9_c, 
                Healthcare_numeric, Race_Black, 
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wavechange_data$ParticipantID) %>%
  unique()

# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wavechange_data, PP_phq9, by = "ParticipantID")


# Linear Model
#################################################
lm.model <- lm(PHQ9_c~ Total_rel+Healthcare_numeric+Race_Black+Ethnicity_Hispanic, 
            data = Plot_data)
summary(lm.model)

ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T1 Alpha Relative Power") + 
  ylab("Post-partum Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")
```






#### 2.4.2 - Delta Waves
```{r}
# Make a dataframe with the summarized data in it
#################################################

# Wave change
Wavechange_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Delta") %>%
  filter(Visit == "T1") %>%
  dplyr::select(ParticipantID,Visit,Freq_int_name,Total_rel)

# add in PHQ9 scores at PP
PP_phq9 <-  Spec_Meta_data %>%
  subset(Visit == "PP") %>%
  dplyr::select(ParticipantID, PHQ9_c, 
                Healthcare_numeric, Race_Black, 
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wavechange_data$ParticipantID) %>%
  unique()

# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wavechange_data, PP_phq9, by = "ParticipantID")


# Linear Model
#################################################
lm.model <- lm(PHQ9_c~ Total_rel+Healthcare_numeric+Race_Black+Ethnicity_Hispanic, 
            data = Plot_data)
summary(lm.model)

ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T1 Delta Relative Power") + 
  ylab("Post-partum Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")
```


#### 2.4.3 - Theta Waves
```{r}
# Make a dataframe with the summarized data in it
#################################################

# Wave change
Wavechange_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Theta") %>%
  filter(Visit == "T1") %>%
  dplyr::select(ParticipantID,Visit,Freq_int_name,Total_rel)

# add in PHQ9 scores at PP
PP_phq9 <-  Spec_Meta_data %>%
  subset(Visit == "PP") %>%
  dplyr::select(ParticipantID, PHQ9_c, 
                Healthcare_numeric, Race_Black, 
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wavechange_data$ParticipantID) %>%
  unique()

# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wavechange_data, PP_phq9, by = "ParticipantID")


# Linear Model
#################################################
lm.model <- lm(PHQ9_c~ Total_rel+Healthcare_numeric+Race_Black+Ethnicity_Hispanic, 
            data = Plot_data)
summary(lm.model)

ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T1 Theta Relative Power") + 
  ylab("Post-partum Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")
```


#### 2.4.4 - Beta Waves
```{r}
# Make a dataframe with the summarized data in it
#################################################

# Wave change
Wavechange_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Beta") %>%
  filter(Visit == "T1") %>%
  dplyr::select(ParticipantID,Visit,Freq_int_name,Total_rel)

# add in PHQ9 scores at PP
PP_phq9 <-  Spec_Meta_data %>%
  subset(Visit == "PP") %>%
  dplyr::select(ParticipantID, PHQ9_c, 
                Healthcare_numeric, Race_Black, 
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wavechange_data$ParticipantID) %>%
  unique()

# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wavechange_data, PP_phq9, by = "ParticipantID")


# Linear Model
#################################################
lm.model <- lm(PHQ9_c~ Total_rel+Healthcare_numeric+Race_Black+Ethnicity_Hispanic, 
            data = Plot_data)
summary(lm.model)

ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T1 Beta Relative Power") + 
  ylab("Post-partum Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")
```




#### 2.4.5 - Gamma Waves
```{r}
# Make a dataframe with the summarized data in it
#################################################

# Wave change
Wavechange_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Gamma") %>%
  filter(Visit == "T1") %>%
  dplyr::select(ParticipantID,Visit,Freq_int_name,Total_rel)

# add in PHQ9 scores at PP
PP_phq9 <-  Spec_Meta_data %>%
  subset(Visit == "PP") %>%
  dplyr::select(ParticipantID, PHQ9_c, 
                Healthcare_numeric, Race_Black, 
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wavechange_data$ParticipantID) %>%
  unique()

# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wavechange_data, PP_phq9, by = "ParticipantID")


# Linear Model
#################################################
lm.model <- lm(PHQ9_c~ Total_rel+Healthcare_numeric+Race_Black+Ethnicity_Hispanic, 
            data = Plot_data)
summary(lm.model)

ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T1 Gamma Relative Power") + 
  ylab("Post-partum Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")
```








### 2.5 - Predict T3 PHQ9 from 20wk Waves

Try predicting T3 mental health scores from 20 wk wave forms

#### 2.5.1 - Alpha Waves
```{r}
# Make a dataframe with the summarized data in it
#################################################

# Wave change
Wavechange_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Alpha") %>%
  filter(Visit == "SV") %>%
  dplyr::select(ParticipantID,Visit,Freq_int_name,Total_rel)

# add in PHQ9 scores at T3
T3_phq9 <-  Spec_Meta_data %>%
  subset(Visit == "T3") %>%
  dplyr::select(ParticipantID, PHQ9_c, 
                Healthcare_numeric, Race_Black, 
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wavechange_data$ParticipantID) %>%
  unique()

# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wavechange_data, T3_phq9, by = "ParticipantID")


# Linear Model
#################################################
lm.model <- lm(PHQ9_c~ Total_rel+Healthcare_numeric+Race_Black+Ethnicity_Hispanic, 
            data = Plot_data)
summary(lm.model)

ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("20 week Alpha Relative Power predicts T3 PHQ9") + 
  ylab("36 GWs Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")
```


#### 2.5.2 - Delta Waves
```{r}
# Make a dataframe with the summarized data in it
#################################################

# Wave change
Wavechange_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Delta") %>%
  filter(Visit == "SV") %>%
  dplyr::select(ParticipantID,Visit,Freq_int_name,Total_rel)

# add in PHQ9 scores at T3
T3_phq9 <-  Spec_Meta_data %>%
  subset(Visit == "T3") %>%
  dplyr::select(ParticipantID, PHQ9_c, 
                Healthcare_numeric, Race_Black, 
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wavechange_data$ParticipantID) %>%
  unique()

# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wavechange_data, T3_phq9, by = "ParticipantID")


# Linear Model
#################################################
lm.model <- lm(PHQ9_c~ Total_rel+Healthcare_numeric+Race_Black+Ethnicity_Hispanic, 
            data = Plot_data)
summary(lm.model)

ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("20 GWs Relative Delta Power") + 
  ylab("36 GWs Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")
```




#### 2.5.3 - Theta Waves
```{r}
# Make a dataframe with the summarized data in it
#################################################

# Wave change
Wavechange_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Alpha") %>%
  filter(Visit == "SV") %>%
  dplyr::select(ParticipantID,Visit,Freq_int_name,Total_rel)

# add in PHQ9 scores at T3
T3_phq9 <-  Spec_Meta_data %>%
  subset(Visit == "T3") %>%
  dplyr::select(ParticipantID, PHQ9_c, 
                Healthcare_numeric, Race_Black, 
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wavechange_data$ParticipantID) %>%
  unique()

# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wavechange_data, T3_phq9, by = "ParticipantID")


# Linear Model
#################################################
lm.model <- lm(PHQ9_c~ Total_rel+Healthcare_numeric+Race_Black+Ethnicity_Hispanic, 
            data = Plot_data)
summary(lm.model)

ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("20 week Alpha Relative Power predicts T3 PHQ9") + 
  ylab("36 GWs Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")

```




#### 2.5.4 - Beta Waves
```{r}
# Make a dataframe with the summarized data in it
#################################################

# Wave change
Wavechange_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Beta") %>%
  filter(Visit == "T1") %>%
  dplyr::select(ParticipantID,Visit,Freq_int_name,Total_rel)

# add in PHQ9 scores at T3
T3_phq9 <-  Spec_Meta_data %>%
  subset(Visit == "SV") %>%
  dplyr::select(ParticipantID, PHQ9_c, 
                Healthcare_numeric, Race_Black, 
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wavechange_data$ParticipantID) %>%
  unique()

# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wavechange_data, T3_phq9, by = "ParticipantID")


# Linear Model
#################################################
lm.model <- lm(PHQ9_c~ Total_rel+Healthcare_numeric+Race_Black+Ethnicity_Hispanic, 
            data = Plot_data)
summary(lm.model)

ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("20 week Beta Relative Power predicts T3 PHQ9") + 
  ylab("36 GWs Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")

```









#### 2.5.5 - Gamma Waves
```{r}
# Make a dataframe with the summarized data in it
#################################################

# Wave change
Wavechange_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Gamma") %>%
  filter(Visit == "SV") %>%
  dplyr::select(ParticipantID,Visit,Freq_int_name,Total_rel)

# add in PHQ9 scores at T3
T3_phq9 <-  Spec_Meta_data %>%
  subset(Visit == "T3") %>%
  dplyr::select(ParticipantID, PHQ9_c, 
                Healthcare_numeric, Race_Black, 
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wavechange_data$ParticipantID) %>%
  unique()

# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wavechange_data, T3_phq9, by = "ParticipantID")


# Linear Model
#################################################
lm.model <- lm(PHQ9_c~ Total_rel+Healthcare_numeric+Race_Black+Ethnicity_Hispanic, 
            data = Plot_data)
summary(lm.model)

ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("20 week Alpha Relative Power predicts T3 PHQ9") + 
  ylab("36 GWs Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")

```






### 2.6 - Predict PP PHQ9 from 20wk Waves

Try predicting PP mental health scores from 20 week wave forms

#### 2.6.1 - Alpha Waves
```{r}
# Make a dataframe with the summarized data in it
#################################################

# Wave change
Wavechange_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Alpha") %>%
  filter(Visit == "SV") %>%
  dplyr::select(ParticipantID,Visit,Freq_int_name,Total_rel)

# add in PHQ9 scores at PP
PP_phq9 <-  Spec_Meta_data %>%
  subset(Visit == "PP") %>%
  dplyr::select(ParticipantID, PHQ9_c, 
                Healthcare_numeric, Race_Black, 
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wavechange_data$ParticipantID) %>%
  unique()

# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wavechange_data, PP_phq9, by = "ParticipantID")


# Linear Model
#################################################
lm.model <- lm(PHQ9_c~ Total_rel+Healthcare_numeric+Race_Black+Ethnicity_Hispanic, 
            data = Plot_data)
summary(lm.model)

ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("20 GWs Alpha Relative Power") + 
  ylab("Post-partum Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")
```






#### 2.6.2 - Delta Waves
```{r}
# Make a dataframe with the summarized data in it
#################################################

# Wave change
Wavechange_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Delta") %>%
  filter(Visit == "SV") %>%
  dplyr::select(ParticipantID,Visit,Freq_int_name,Total_rel)

# add in PHQ9 scores at PP
PP_phq9 <-  Spec_Meta_data %>%
  subset(Visit == "PP") %>%
  dplyr::select(ParticipantID, PHQ9_c, 
                Healthcare_numeric, Race_Black, 
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wavechange_data$ParticipantID) %>%
  unique()

# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wavechange_data, PP_phq9, by = "ParticipantID")


# Linear Model
#################################################
lm.model <- lm(PHQ9_c~ Total_rel+Healthcare_numeric+Race_Black+Ethnicity_Hispanic, 
            data = Plot_data)
summary(lm.model)

ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("20 GWs Delta Relative Power") + 
  ylab("Post-partum Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")
```


#### 2.6.3 - Theta Waves
```{r}
# Make a dataframe with the summarized data in it
#################################################

# Wave change
Wavechange_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Theta") %>%
  filter(Visit == "SV") %>%
  dplyr::select(ParticipantID,Visit,Freq_int_name,Total_rel)

# add in PHQ9 scores at PP
PP_phq9 <-  Spec_Meta_data %>%
  subset(Visit == "PP") %>%
  dplyr::select(ParticipantID, PHQ9_c, 
                Healthcare_numeric, Race_Black, 
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wavechange_data$ParticipantID) %>%
  unique()

# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wavechange_data, PP_phq9, by = "ParticipantID")


# Linear Model
#################################################
lm.model <- lm(PHQ9_c~ Total_rel+Healthcare_numeric+Race_Black+Ethnicity_Hispanic, 
            data = Plot_data)
summary(lm.model)

ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("20 GWs Theta Relative Power") + 
  ylab("Post-partum Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")
```


#### 2.6.4 - Beta Waves
```{r}
# Make a dataframe with the summarized data in it
#################################################

# Wave change
Wavechange_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Beta") %>%
  filter(Visit == "SV") %>%
  dplyr::select(ParticipantID,Visit,Freq_int_name,Total_rel)

# add in PHQ9 scores at PP
PP_phq9 <-  Spec_Meta_data %>%
  subset(Visit == "PP") %>%
  dplyr::select(ParticipantID, PHQ9_c, 
                Healthcare_numeric, Race_Black, 
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wavechange_data$ParticipantID) %>%
  unique()

# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wavechange_data, PP_phq9, by = "ParticipantID")


# Linear Model
#################################################
lm.model <- lm(PHQ9_c~ Total_rel+Healthcare_numeric+Race_Black+Ethnicity_Hispanic, 
            data = Plot_data)
summary(lm.model)

ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("20 GWs Beta Relative Power") + 
  ylab("Post-partum Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")
```




#### 2.6.5 - Gamma Waves
```{r}
# Make a dataframe with the summarized data in it
#################################################

# Wave change
Wavechange_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Gamma") %>%
  filter(Visit == "SV") %>%
  dplyr::select(ParticipantID,Visit,Freq_int_name,Total_rel)

# add in PHQ9 scores at PP
PP_phq9 <-  Spec_Meta_data %>%
  subset(Visit == "PP") %>%
  dplyr::select(ParticipantID, PHQ9_c, 
                Healthcare_numeric, Race_Black, 
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wavechange_data$ParticipantID) %>%
  unique()

# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wavechange_data, PP_phq9, by = "ParticipantID")


# Linear Model
#################################################
lm.model <- lm(PHQ9_c~ Total_rel+Healthcare_numeric+Race_Black+Ethnicity_Hispanic, 
            data = Plot_data)
summary(lm.model)

ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("20 GWs Gamma Relative Power") + 
  ylab("Post-partum Adjusted PHQ-9") +
  theme(axis.text=element_text(size=14, , face = "bold"), axis.title=element_text(size=20))+
  geom_point(data = Plot_data, aes(x = Total_rel, y = PHQ9_c, 
                                   col = SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")
```



## Part 3: GAD7 Analaysis 
***
### 3.1 - GAD7 predicted by Relative Power by Visit (Linear Models)


#### 3.1.1 - First Trimester GAD-7
Relative Power as a function of GAD-7 for first trimester

```{r warning = F}
#Step 1: Prep the data
################################################################################
T1_Plot_data <- Spec_Meta_data %>% subset(Visit == "T1")


#Relative Theta
###############################################################################
Plot_data <- T1_Plot_data %>% subset(Freq_int_name == "Theta")
lm.model <- lm(loggad7_c ~ Total_rel  + Healthcare_numeric + Ethnicity_Hispanic + Race_Black+ EGA_c, data = Plot_data)
  #previous model lm(loggad7 ~ Total_rel + Age + Healthcare_numeric + Race_Black+ Ethnicity_Hispanic, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T1 Relative Theta Power") + 
  ylab("Scaled GAD-7")

# Find the subset of plot data used in the lm.model
Plot_data_subset <- Plot_data[row.names(model.frame(lm.model)),]

# Find covariate adjusted loggad7_c
loggad7_c_adjusted <- with(Plot_data_subset, {
  loggad7_c - 
  Healthcare_numeric * coef(lm.model)["Healthcare_numeric"] - 
  Ethnicity_Hispanic * coef(lm.model)["Ethnicity_Hispanic"] - 
  Race_Black * coef(lm.model)["Race_Black"] - 
  EGA_c * coef(lm.model)["EGA_c"]
})
#construct a dataframe with the adjusted values and the SplitEGA_c used for the point color scheme
adjusted <- data.frame(
  loggad7_c_adjusted = loggad7_c_adjusted,
  Total_rel = Plot_data$Total_rel,
  SplitEGA_c = Plot_data$SplitEGA_c  
)

#Plot!
 ggplot(adjusted, aes(x = Total_rel, y = loggad7_c_adjusted)) + 
    geom_point(data = adjusted, aes(x = Total_rel, y = loggad7_c_adjusted, col = adjusted$SplitEGA_c), size = 5, stroke = NA) +
    stat_smooth(method = "lm", col = "red", linetype = "dashed", linewidth = 1) +
    labs(title = paste("Adj R2 = ",signif(summary(lm.model)$adj.r.squared, 5),
                     "Intercept =",signif(lm.model$coef[[1]],5 ),
                     " Slope =",signif(lm.model$coef[[2]], 5),
                     " P =",signif(summary(lm.model)$coef[2,4], 5))) + theme_classic() + 
  xlab("<16 GWs Relative Theta Power") + 
  ylab("<16 GWs Adjusted GAD-7") +
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20), face = "bold") +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")
#Relative Beta
###############################################################################
Plot_data <- T1_Plot_data %>% subset(Freq_int_name == "Beta")
lm.model <- lm(loggad7_c ~ Total_rel  + Healthcare_numeric + Ethnicity_Hispanic + Race_Black+ EGA_c, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T1 Relative Beta Power") + 
  ylab("Scaled GAD-7")


#Relative Alpha
###############################################################################
Plot_data <- T1_Plot_data %>% subset(Freq_int_name == "Alpha")
lm.model <- lm(loggad7_c ~ Total_rel + Healthcare_numeric + Ethnicity_Hispanic + Race_Black+ EGA_c, data = Plot_data)
summary(lm.model)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T1 Relative Alpha Power") + 
  ylab("Scaled GAD-7")#+expand_limits(y=c(0, 5))+ theme(axis.title.y = element_text(hjust = 0.25))




#Relative Delta
###############################################################################
# filter data to whatever waveform + visit we are plotting
Plot_data <- T1_Plot_data %>% subset(Freq_int_name == "Delta")
# find the linear model
lm.model <-lm(loggad7_c ~ Total_rel  + Healthcare_numeric + Ethnicity_Hispanic + Race_Black+ EGA_c, data = Plot_data)

#plot based on fitted values
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T1 Relative Delta Power") + 
  ylab("Scaled GAD-7")#+expand_limits(y=c(0, 5))+ theme(axis.title.y = element_text(hjust = 0.25))

Plot_data <- T1_Plot_data %>% subset(Freq_int_name == "Delta")
lm.model <-lm(loggad7_c ~ Total_rel  + Healthcare_numeric + Ethnicity_Hispanic + Race_Black+ EGA_c, data = Plot_data)
lm.model$SplitEGA_c<-Plot_data[row.names(model.frame(lm.model)),]$SplitEGA_c
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("<16 GWs Relative Delta Power") + 
  ylab("<16 GWs Adjusted GAD-7") +
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20), face = "bold")+
  geom_point(data = lm.model , aes(x = lm.model$model[[2]], y = fitted(lm.model), col = lm.model$SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")


# find the subset of plot data used in the lm.model
Plot_data_subset <- Plot_data[row.names(model.frame(lm.model)),]

# find covariate adjusted loggad7_c
loggad7_c_adjusted <- with(Plot_data_subset, {
  loggad7_c - 
  Healthcare_numeric * coef(lm.model)["Healthcare_numeric"] - 
  Ethnicity_Hispanic * coef(lm.model)["Ethnicity_Hispanic"] - 
  Race_Black * coef(lm.model)["Race_Black"] - 
  EGA_c * coef(lm.model)["EGA_c"]
})
# construct a dataframe with the adjusted values and the SplitEGA_c used for the point color scheme
adjusted <- data.frame(
  loggad7_c_adjusted = loggad7_c_adjusted,
  Total_rel = Plot_data_subset$Total_rel,
  SplitEGA_c = Plot_data_subset$SplitEGA_c  
)

# plot based on adjusted loggad7_c
 ggplot(adjusted, aes(x = Total_rel, y = loggad7_c_adjusted)) + 
    geom_point(data = adjusted, aes(x = Total_rel, y = loggad7_c_adjusted, col = adjusted$SplitEGA_c), size = 5, stroke = NA) +
    stat_smooth(method = "lm", col = "red", linetype = "dashed", linewidth = 1) +
    labs(title = paste("Adj R2 = ",signif(summary(lm.model)$adj.r.squared, 5),
                     "Intercept =",signif(lm.model$coef[[1]],5 ),
                     " Slope =",signif(lm.model$coef[[2]], 5),
                     " P =",signif(summary(lm.model)$coef[2,4], 5))) + theme_classic() + 
  xlab("<16 GWs Relative Delta Power") + 
  ylab("<16 GWs Adjusted GAD-7") +
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20), face = "bold") +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA")#+ ylim(-1,1)

####
  

###
#Relative Gamma
Plot_data <- T1_Plot_data %>% subset(Freq_int_name == "Gamma")
###############################################################################
lm.model <- lm(loggad7_c ~ Total_rel  + Healthcare_numeric + Ethnicity_Hispanic + Race_Black+ EGA_c, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T1 Relative Gamma Power") + 
  ylab("Scaled GAD-7")

```

#### 3.1.2 - SV/20Wk GAD-7

```{r}
#Step 1: Prep the data
################################################################################
SV_Plot_data <- Spec_Meta_data %>% subset(Visit == "SV")

#Relative Theta
###############################################################################
Plot_data <- SV_Plot_data %>% subset(Freq_int_name == "Theta")
lm.model <- lm(loggad7_c ~ Total_rel  + Healthcare_numeric + Ethnicity_Hispanic + Race_Black+ EGA_c, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("SV/20Wk Relative Theta Power") + 
  ylab("Scaled GAD-7")


#Relative Beta
###############################################################################
Plot_data <- SV_Plot_data %>% subset(Freq_int_name == "Beta")
lm.model <- lm(loggad7_c ~ Total_rel  + Healthcare_numeric + Ethnicity_Hispanic + Race_Black+ EGA_c, data = Plot_data)
lm.model
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("SV/20Wk Relative Beta Power") + 
  ylab("Scaled GAD-7")


#Relative Alpha
###############################################################################
Plot_data <- SV_Plot_data %>% subset(Freq_int_name == "Alpha")
lm.model <- lm(loggad7_c ~ Total_rel  + Healthcare_numeric + Ethnicity_Hispanic + Race_Black+ EGA_c, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("SV/20Wk Relative Alpha Power") + 
  ylab("Scaled GAD-7")#+expand_limits(y=c(0, 5))+ theme(axis.title.y = element_text(hjust = 0.25))
###

lm.model$SplitEGA_c<-Plot_data[row.names(model.frame(lm.model)),]$SplitEGA_c
ggplotRegression(lm.model)   + 
  theme_classic() +
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20), face = "bold") + 
  xlab("20 GWs Relative Alpha Power") + 
  ylab("20 GWs Adjusted GAD-7")+
  geom_point(data = lm.model , aes(x = lm.model$model[[2]], y = fitted(lm.model), col = lm.model$SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")) + labs (color = "Scaled EGA")

###
Plot_data_subset <- Plot_data[row.names(model.frame(lm.model)),]

# Find covariate adjusted loggad7_c
loggad7_c_adjusted <- with(Plot_data_subset, {
  loggad7_c - 
 Healthcare_numeric * coef(lm.model)["Healthcare_numeric"] - 
 Ethnicity_Hispanic * coef(lm.model)["Ethnicity_Hispanic"] - 
 Race_Black * coef(lm.model)["Race_Black"] - 
  EGA_c * coef(lm.model)["EGA_c"]
})
#construct a dataframe with the adjusted values and the SplitEGA_c used for the point color scheme
adjusted <- data.frame(
  loggad7_c_adjusted = loggad7_c_adjusted,
  Total_rel = Plot_data_subset$Total_rel,
  SplitEGA_c = Plot_data_subset$SplitEGA_c  
)

#Plot!
 ggplot(adjusted, aes(x = Total_rel, y = loggad7_c_adjusted)) + 
    geom_point(data = adjusted, aes(x = Total_rel, y = loggad7_c_adjusted, col = adjusted$SplitEGA_c), size = 5, stroke = NA) +
    stat_smooth(method = "lm", col = "red", linetype = "dashed", linewidth = 1) +
    labs(title = paste("Adj R2 = ",signif(summary(lm.model)$adj.r.squared, 5),
                     "Intercept =",signif(lm.model$coef[[1]],5 ),
                     " Slope =",signif(lm.model$coef[[2]], 5),
                     " P =",signif(summary(lm.model)$coef[2,4], 5))) + theme_classic() + 
  xlab("<16 GWs Relative Delta Power") + 
  ylab("<16 GWs Adjusted GAD-7") +
  xlab("20 GWs Relative Alpha Power") + 
  ylab("20 GWs Adjusted GAD-7")+
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20), face = "bold") +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA") #+    ylim(-1, 1)


#Relative Delta
###############################################################################
Plot_data <- SV_Plot_data %>% subset(Freq_int_name == "Delta")
lm.model <- lm(loggad7_c ~ Total_rel + Healthcare_numeric + Ethnicity_Hispanic + Race_Black+ EGA_c, data = Plot_data)
lm.model$SplitEGA_c<-Plot_data[row.names(model.frame(lm.model)),]$SplitEGA_c
ggplotRegression(lm.model)   + 
  theme_classic() +
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20), face = "bold") + 
  xlab("20 GWs Relative Delta Power") + 
  ylab("20 GWs Adjusted GAD-7")+
  geom_point(data = lm.model , aes(x = lm.model$model[[2]], y = fitted(lm.model), col = lm.model$SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")) + labs (color = "Scaled EGA")


# Find the subset of plot data used in the lm.model
Plot_data_subset <- Plot_data[row.names(model.frame(lm.model)),]

# Find covariate adjusted loggad7_c
loggad7_c_adjusted <- with(Plot_data_subset, {
  loggad7_c - 
 Healthcare_numeric * coef(lm.model)["Healthcare_numeric"] - 
 Ethnicity_Hispanic * coef(lm.model)["Ethnicity_Hispanic"] - 
  Race_Black * coef(lm.model)["Race_Black"] - 
  EGA_c * coef(lm.model)["EGA_c"]
})
#construct a dataframe with the adjusted values and the SplitEGA_c used for the point color scheme
adjusted <- data.frame(
  loggad7_c_adjusted = loggad7_c_adjusted,
  Total_rel = Plot_data_subset$Total_rel,
  SplitEGA_c = Plot_data_subset$SplitEGA_c  
)

#Plot!
 ggplot(adjusted, aes(x = Total_rel, y = loggad7_c_adjusted)) + 
    geom_point(data = adjusted, aes(x = Total_rel, y = loggad7_c_adjusted, col = adjusted$SplitEGA_c), size = 5, stroke = NA) +
    stat_smooth(method = "lm", col = "red", linetype = "dashed", linewidth = 1) +
    labs(title = paste("Adj R2 = ",signif(summary(lm.model)$adj.r.squared, 5),
                     "Intercept =",signif(lm.model$coef[[1]],5 ),
                     " Slope =",signif(lm.model$coef[[2]], 5),
                     " P =",signif(summary(lm.model)$coef[2,4], 5))) + theme_classic() + 
   xlab("20 GWs Relative Delta Power") + 
  ylab("20 GWs Adjusted GAD-7")+
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20), face = "bold") +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA") #+    ylim(-1, 1)

#Relative Gamma
###############################################################################
Plot_data <- SV_Plot_data %>% subset(Freq_int_name == "Gamma")
lm.model <- lm(loggad7_c ~ Total_rel  + Healthcare_numeric + Ethnicity_Hispanic + Race_Black+ EGA_c, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("SV/20Wk Relative Gamma Power") + 
  ylab("Scaled GAD-7")
```

#### 3.1.3 - Second Trimester GAD-7

```{r}
#Step 1: Prep the data
################################################################################
T2_Plot_data <- Spec_Meta_data %>% subset(Visit == "T2")

#Relative Theta
###############################################################################
Plot_data <- T2_Plot_data %>% subset(Freq_int_name == "Theta")
lm.model <- lm(loggad7_c ~ Total_rel   + Healthcare_numeric + Ethnicity_Hispanic + Race_Black+ EGA_c, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T2 Relative Theta Power") + 
  ylab("Scaled GAD-7")


#Relative Beta
###############################################################################
Plot_data <- T2_Plot_data %>% subset(Freq_int_name == "Beta")
lm.model <- lm(loggad7_c ~ Total_rel   + Healthcare_numeric + Ethnicity_Hispanic + Race_Black+ EGA_c, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T2 Relative Beta Power") + 
  ylab("Scaled GAD-7")


#Relative Alpha
###############################################################################
Plot_data <- T2_Plot_data %>% subset(Freq_int_name == "Alpha")
lm.model <- lm(loggad7_c ~ Total_rel   + Healthcare_numeric + Ethnicity_Hispanic + Race_Black+ EGA_c, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T2 Relative Alpha Power") + 
  ylab("Scaled GAD-7")#+expand_limits(y=c(0, 5))+ theme(axis.title.y = element_text(hjust = 0.25))


#Relative Delta
###############################################################################
Plot_data <- T2_Plot_data %>% subset(Freq_int_name == "Delta")
lm.model <- lm(loggad7_c ~ Total_rel   + Healthcare_numeric + Ethnicity_Hispanic + Race_Black+ EGA_c, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T2 Relative Delta Power") + 
  ylab("Scaled GAD-7")#+expand_limits(y=c(0, 5))+ theme(axis.title.y = element_text(hjust = 0.25))

#Relative Gamma
###############################################################################
Plot_data <- T2_Plot_data %>% subset(Freq_int_name == "Gamma")
lm.model <- lm(loggad7_c ~ Total_rel   + Healthcare_numeric + Ethnicity_Hispanic + Race_Black+ EGA_c, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T2 Relative Gamma Power") + 
  ylab("Scaled GAD-7")

```

#### 3.1.4 - Third Trimester GAD-7

```{r}
#Step 1: Prep the data
################################################################################
T3_Plot_data <- Spec_Meta_data %>% subset(Visit == "T3")

#Relative Theta
###############################################################################
Plot_data <- T3_Plot_data %>% subset(Freq_int_name == "Theta")
lm.model <- lm(loggad7_c ~ Total_rel   + Healthcare_numeric + Ethnicity_Hispanic + Race_Black+ EGA_c, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T3 Relative Theta Power") + 
  ylab("Scaled GAD-7")


#Relative Beta
###############################################################################
Plot_data <- T3_Plot_data %>% subset(Freq_int_name == "Beta")
lm.model <- lm(loggad7_c ~ Total_rel   + Healthcare_numeric + Ethnicity_Hispanic + Race_Black+ EGA_c, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T3 Relative Beta Power") + 
  ylab("Scaled GAD-7")


#Relative Alpha
###############################################################################
Plot_data <- T3_Plot_data %>% subset(Freq_int_name == "Alpha")
lm.model <- lm(loggad7_c ~ Total_rel   + Healthcare_numeric + Ethnicity_Hispanic + Race_Black+ EGA_c, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T3 Relative Alpha Power") + 
  ylab("Scaled GAD-7")

#
p<- ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("Relative Alpha Power") + 
  ylab("Centered Log GAD-7")

p + geom_point(data = Plot_data, aes(x = Total_rel, y = loggad7_c, color = Antenatal_EGA_c)) + scale_color_gradient(low = "cyan", high = "darkblue", limits = c(0,1)) + labs (color = "EGA")


#Relative Delta
###############################################################################
Plot_data <- T3_Plot_data %>% subset(Freq_int_name == "Delta")
lm.model <- lm(loggad7_c ~ Total_rel   + Healthcare_numeric + Ethnicity_Hispanic + Race_Black+ EGA_c, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T3 Relative Delta Power") + 
  ylab("Scaled GAD-7")
#Relative Gamma
###############################################################################
Plot_data <- T3_Plot_data %>% subset(Freq_int_name == "Gamma")
lm.model <- lm(loggad7_c ~ Total_rel   + Healthcare_numeric + Ethnicity_Hispanic + Race_Black+ EGA_c, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("T3 Relative Gamma Power") + 
  ylab("Scaled GAD-7")
```

#### 3.1.5 - Postpartum GAD-7

```{r}
#Step 1: Prep the data
################################################################################
PP_Plot_data <- Spec_Meta_data %>% subset(Visit == "PP")

#Relative Theta
###############################################################################
Plot_data <- PP_Plot_data %>% subset(Freq_int_name == "Theta")
lm.model <- lm(loggad7_c ~ Total_rel  + Healthcare_numeric + Ethnicity_Hispanic + Race_Black+ EGA_c, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("Relative Theta Power") + 
  ylab("Scaled GAD-7")


#Relative Beta
###############################################################################
Plot_data <- PP_Plot_data %>% subset(Freq_int_name == "Beta")
lm.model <- lm(loggad7_c ~ Total_rel  + Healthcare_numeric + Ethnicity_Hispanic + Race_Black+ EGA_c, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("Relative Beta Power") + 
  ylab("Scaled GAD-7")


#Relative Alpha
###############################################################################
Plot_data <- PP_Plot_data %>% subset(Freq_int_name == "Alpha")
lm.model <- lm(loggad7_c ~ Total_rel + Healthcare_numeric + Ethnicity_Hispanic + Race_Black+ EGA_c, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("Relative Alpha Power") + 
  ylab("Scaled GAD-7")#+ expand_limits(y=c(0, 5))+ theme(axis.title.y = element_text(hjust = 0.25))

###

Plot_data <- PP_Plot_data %>% subset(Freq_int_name == "Alpha")
lm.model <- lm(loggad7_c ~ Total_rel + Healthcare_numeric + Ethnicity_Hispanic + Race_Black+ EGA_c, data = Plot_data)
lm.model$SplitEGA_c<-Plot_data[row.names(model.frame(lm.model)),]$SplitEGA_c
ggplotRegression(lm.model)    + 
  theme_classic() +
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20), face = "bold") + 
  ggtitle("")+
  xlab("Postpartum Relative Alpha Power") + 
  ylab("Postpartum Adjusted GAD-7")+
  geom_point(data = lm.model , aes(x = lm.model$model[[2]], y = fitted(lm.model), col = lm.model$SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")) + theme(legend.title=element_text(size=14), 
    legend.text=element_text(size=11)) + labs (color = "Scaled EGA")

# Find the subset of plot data used in the lm.model
Plot_data_subset <- Plot_data[row.names(model.frame(lm.model)),]

# Find covariate adjusted loggad7_c
loggad7_c_adjusted <- with(Plot_data_subset, {
  loggad7_c - 
  Healthcare_numeric * coef(lm.model)["Healthcare_numeric"] - 
  Ethnicity_Hispanic * coef(lm.model)["Ethnicity_Hispanic"] - 
  Race_Black * coef(lm.model)["Race_Black"] - 
  EGA_c * coef(lm.model)["EGA_c"]
})
#construct a dataframe with the adjusted values and the SplitEGA_c used for the point color scheme
adjusted <- data.frame(
  loggad7_c_adjusted = loggad7_c_adjusted,
  Total_rel = Plot_data_subset$Total_rel,
  SplitEGA_c = Plot_data_subset$SplitEGA_c  
)

#Plot!
 ggplot(adjusted, aes(x = Total_rel, y = loggad7_c_adjusted)) + 
    geom_point(data = adjusted, aes(x = Total_rel, y = loggad7_c_adjusted, col = adjusted$SplitEGA_c), size = 5, stroke = NA) +
    stat_smooth(method = "lm", col = "red", linetype = "dashed", linewidth = 1) +
    labs(title = paste("Adj R2 = ",signif(summary(lm.model)$adj.r.squared, 5),
                     "Intercept =",signif(lm.model$coef[[1]],5 ),
                     " Slope =",signif(lm.model$coef[[2]], 5),
                     " P =",signif(summary(lm.model)$coef[2,4], 5))) + theme_classic() + 
  xlab("Postpartum Relative Alpha Power") + 
  ylab("Postpartum Adjusted GAD-7")+
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20), face = "bold") +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA") #+    ylim(-1, 1)
##
#Relative Delta
###############################################################################
Plot_data <- PP_Plot_data %>% subset(Freq_int_name == "Delta")
lm.model <- lm(loggad7_c ~ Total_rel  + Healthcare_numeric + Ethnicity_Hispanic + Race_Black+ EGA_c, data = Plot_data)
lm.model$SplitEGA_c<-Plot_data[row.names(model.frame(lm.model)),]$SplitEGA_c
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("Relative Delta Power") + 
  ylab("Scaled GAD-7")#+ expand_limits(y=c(0, 5))+ theme(axis.title.y = element_text(hjust = 0.25))


##
ggplotRegression(lm.model)   + 
  theme_classic() +
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20), face = "bold") + 
  xlab("Postpartum Relative Delta Power") + 
  ylab("Postpartum Adjusted GAD-7")+
  ggtitle("")+
   geom_point(data = lm.model , aes(x = lm.model$model[[2]], y = fitted(lm.model), col = lm.model$SplitEGA_c), size = 5, stroke = NA) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15)) + labs (color = "Scaled EGA")

# Find the subset of plot data used in the lm.model
Plot_data_subset <- Plot_data[row.names(model.frame(lm.model)),]

# Find covariate adjusted loggad7_c
loggad7_c_adjusted <- with(Plot_data_subset, {
  loggad7_c - 
  Healthcare_numeric * coef(lm.model)["Healthcare_numeric"] - 
 Ethnicity_Hispanic * coef(lm.model)["Ethnicity_Hispanic"] - 
  Race_Black * coef(lm.model)["Race_Black"] - 
  EGA_c * coef(lm.model)["EGA_c"]
})
#construct a dataframe with the adjusted values and the SplitEGA_c used for the point color scheme
adjusted <- data.frame(
  loggad7_c_adjusted = loggad7_c_adjusted,
  Total_rel = Plot_data_subset$Total_rel,
  SplitEGA_c = Plot_data_subset$SplitEGA_c  
)

#Plot!
 ggplot(adjusted, aes(x = Total_rel, y = loggad7_c_adjusted)) + 
    geom_point(data = adjusted, aes(x = Total_rel, y = loggad7_c_adjusted, col = adjusted$SplitEGA_c), size = 5, stroke = NA) +
    stat_smooth(method = "lm", col = "red", linetype = "dashed", linewidth = 1) +
    labs(title = paste("Adj R2 = ",signif(summary(lm.model)$adj.r.squared, 5),
                     "Intercept =",signif(lm.model$coef[[1]],5 ),
                     " Slope =",signif(lm.model$coef[[2]], 5),
                     " P =",signif(summary(lm.model)$coef[2,4], 5))) + theme_classic() + 
   xlab("Postpartum Relative Delta Power") + 
  ylab("Postpartum Adjusted GAD-7")+
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20), face = "bold") +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA") #+    ylim(-1, 1)
##
##
#Relative Gamma
###############################################################################
Plot_data <- PP_Plot_data %>% subset(Freq_int_name == "Gamma")
lm.model <- lm(loggad7_c ~ Total_rel  + Healthcare_numeric + Ethnicity_Hispanic + Race_Black+ EGA_c, data = Plot_data)
ggplotRegression(lm.model)   + 
  theme_classic() + 
  xlab("Relative Gamma Power") + 
  ylab("Scaled GAD-7")
```




### 3.2 - GAD7/Relative Power (Linear Mixed Models)

Filter to participants with 3 or more visits for Linear Mixed Effect Models

#### 3.2.1 - Alpha wave (perinatal)



For this linear mixed model, allowing Total_rel slope to vary participant to participant

```{r}
# Step 1: Filter to Alpha Power
#################################################################
Plot_data <- Spec_Meta_data %>% subset(Freq_int_name == "Alpha")%>% group_by(ParticipantID) %>%
  filter(n() >= 3)
 



# Step 2: Create the Model
#################################################################
LMM <- lmer(loggad7_c ~ Total_rel + Ethnicity_Hispanic + Race_Black + Healthcare_numeric + EGA_c + (Total_rel|ParticipantID), 
                Plot_data, REML=F)
  #previous model lmer (loggad7 ~ Total_rel + Age + EGA+ Race_Black + Ethnicity_Hispanic + Healthcare_numeric + (Total_rel|ParticipantID), Plot_data, REML=F)

#sjPlot::tab_model(LMM)
#sjPlot::tab_model(LMM)
knitr::knit_print(sjPlot::tab_model(LMM))

# Step 3: Plot Fixed Effects of CAT-ANX
#################################################################

# get fixed effects
LMM_effects <- as.data.frame(effects::effect(term= "Total_rel", mod= LMM))

# Step 3: Plot Fixed Effects of centered log GAD7
#################################################################

# Summary of Coefficients
summary_lmer <- summary(LMM)




####################################################
# Merge output into new dataframe for plotting
fitted_vals <- as.matrix(as.numeric(fitted(LMM)))
total_rel <- LMM@frame[["Total_rel"]]
EGA_c <- LMM@frame[["EGA_c"]]
ParticipantID <- LMM@frame[["ParticipantID"]]

plot_data <- data.frame(fitted_vals = fitted_vals, 
                        Total_rel = total_rel, EGA_c = EGA_c, ParticipantID = ParticipantID)
merged_data <- merge(plot_data, Plot_data, by = c("ParticipantID", "EGA_c", "Total_rel"))
# Plot Fitted values
ggplot(merged_data, aes(Total_rel, fitted_vals, col=SplitEGA_c)) +
  geom_point(size = 3.5) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +

  #scale_color_gradientn(
#    colors = c("lightblue", "darkblue", "orange"),
#    values = c(0, 0.9,1),
   # limits = c(0,1.5)) +
  geom_abline(intercept = fixef(LMM)["(Intercept)"], slope = fixef(LMM)["Total_rel"], 
              color = "red", linetype = "dashed", linewidth = 1) +
    
  
  #geom_smooth(method = "lm", 
   #           color = "blue", 
    #          linetype = "solid", 
     #         linewidth = 1, 
      #        fill = "lightblue", 
       #       alpha = 0.3) +
  labs(x = "Relative Alpha Power", y = "Adjusted GAD7", title = "Relative Alpha Power across Overall Perinatal Period", color = "Scaled EGA") + 
 annotate(geom="text", x=0.3, y=1, label=paste0("p-value =",signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits =3)), color="black") +
  theme_classic() +
  theme(axis.text.x = element_text(family = "sans",color = "black", size = 14),
        axis.text.y = element_text(family = "sans",color = "black", size = 14),
        axis.title.x = element_text(family = "sans",color = "black", size = 20),
        axis.title.y = element_text(family = "sans",color = "black", size = 20)) +
  ggtitle("")

# add in the original EGA values etc. 
####################################################################
# Merge output into new dataframe for plotting
fitted_vals <- as.matrix(as.numeric(fitted(LMM)))
total_rel <- LMM@frame[["Total_rel"]]
EGA_c <- LMM@frame[["EGA_c"]]
ParticipantID <- LMM@frame[["ParticipantID"]]

plot_data <- data.frame(fitted_vals = fitted_vals, 
                        Total_rel = total_rel, EGA_c = EGA_c, ParticipantID = ParticipantID)
merged_data <- merge(plot_data, Plot_data, by = c("ParticipantID", "EGA_c", "Total_rel"))


# Plot Fitted values
ggplot(merged_data, aes(Total_rel, fitted_vals, col=EGA_c)) +
  geom_point(size = 1.5) +
  geom_abline(intercept = fixef(LMM)["(Intercept)"], slope = fixef(LMM)["Total_rel"], 
              color = "red", linetype = "dashed", linewidth = 1) +
  labs(x = "Total Relative Alpha Power", y = "Scaled GAD7", title = "Relative Alpha Power across Perinatal Period", color = "Scaled EGA") + 
  annotate(geom="text", x=0.3, y=1, label=paste0("p-value =",signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits =3)), color="black") +
  theme_classic() +
  theme(axis.text.x = element_text(family = "sans",color = "black", size = 14),
        axis.text.y = element_text(family = "sans",color = "black", size = 14),
        axis.title.x = element_text(family = "sans",color = "black", size = 14),
        axis.title.y = element_text(family = "sans",color = "black", size = 14))+
  ggtitle("")

##################################################################################
#Plot raw values
ggplot() + 
geom_point(data=Plot_data, aes(x=Total_rel, y=loggad7_c, color = Visit)) + 
  geom_point(data=LMM_effects, aes(x=Total_rel, y=fit), color="blue") +
  geom_line(data=LMM_effects, aes(x=Total_rel, y=fit), color="blue") +
  geom_ribbon(data=LMM_effects, aes(x=Total_rel, ymin=lower, ymax=upper), 
              alpha= 0.3, fill="blue") +
  theme_classic() + 
  annotate(geom="text", x=0.3, y=1.1, 
           label=paste0("p-value =",signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits =3)),
           color="black") +
  annotate(geom="text", x=0.6, y=1.1, 
           label=paste0("slope =",signif(summary_lmer$coefficients["Total_rel", "Estimate"], digits =3)),
           color="blue") +
  labs(x="Relative Alpha Power", y="Scaled GAD7", title = "Relative Alpha Power across Overall Perinatal Period") 
#Print equation
#extract_eq(LMM)
#################################################################################

#Plot adjusted values
# find the subset of plot data used in the lm.model
Plot_data_subset <- Plot_data[row.names(LMM@frame),]

# find covariate adjusted loggad7_c
loggad7_c_adjusted <- with(Plot_data_subset, {
  loggad7_c - 
  Healthcare_numeric * fixef(LMM)["Healthcare_numeric"] - 
  Ethnicity_Hispanic * fixef(LMM)["Ethnicity_Hispanic"] - 
  Race_Black * fixef(LMM)["Race_Black"] - 
  EGA_c * fixef(LMM)["EGA_c"]
})
# construct a dataframe with the adjusted values and the SplitEGA_c used for the point color scheme
adjusted <- data.frame(
  loggad7_c_adjusted = loggad7_c_adjusted,
  Total_rel = Plot_data_subset$Total_rel,
  SplitEGA_c = Plot_data_subset$SplitEGA_c  
)

# plot based on adjusted loggad7_c
 ggplot(adjusted, aes(x = Total_rel, y = loggad7_c_adjusted)) + 
   
    geom_point(data = adjusted, aes(x = Total_rel, y = loggad7_c_adjusted, col = adjusted$SplitEGA_c), size = 5, stroke = NA) +
   
    stat_smooth(method = "lm", col = "red", linetype = "dashed", linewidth = 1) +
    
   
 #annotate(geom="text", x=0.3, y=1.1, label=paste0("p-value =",signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits =3)), color="goldenrod4") +
 # annotate(geom="text", x=0.6, y=1.1, label=paste0("slope =",signif(summary_lmer$coefficients["Total_rel", "Estimate"], digits =3)), color="goldenrod4") + 
   theme_classic()  +
   theme(axis.text=element_text(size=14), axis.title=element_text(size=20)) +
   
labs(x = "Relative Alpha Power", y = "Adjusted GAD7", title = "Relative Alpha Power across Overall Perinatal Period", color = "Scaled EGA")+
   
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")) #+ ylim(0,1.1)


```



#### 3.2.2 - Beta (perinatal)

```{r}
# Step 1: Filter to Beta Power
#################################################################
Plot_data <- Spec_Meta_data %>% subset(Freq_int_name == "Beta") %>% group_by(ParticipantID) %>%
  filter(n() >= 3) %>%
  ungroup()


# Step 2: Create the Model
#################################################################
LMM <- lmer(loggad7_c ~ Total_rel + Ethnicity_Hispanic  +  Race_Black + Healthcare_numeric + EGA_c + (Total_rel|ParticipantID), 
                Plot_data, REML=F)

sjPlot::tab_model(LMM)
knitr::knit_print(sjPlot::tab_model(LMM))

# Step 3: Plot Fixed Effects of CAT-ANX
#################################################################

# get fixed effects
LMM_effects <- as.data.frame(effects::effect(term= "Total_rel", mod= LMM))

# summary to pull coefficient
summary_lmer <- summary(LMM)

ggplot() + 
geom_point(data=Plot_data, aes(x=Total_rel, y=loggad7_c, color = Visit)) + 
  geom_point(data=LMM_effects, aes(x=Total_rel, y=fit), color="blue") +
  geom_line(data=LMM_effects, aes(x=Total_rel, y=fit), color="blue") +
  geom_ribbon(data=LMM_effects, aes(x=Total_rel, ymin=lower, ymax=upper), 
              alpha= 0.3, fill="blue") +
  theme_classic() + 
  annotate(geom="text", x=0.1, y=1, 
           label=paste0("p-value =",signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits =3)),
           color="black") +
  annotate(geom="text", x=0.3, y=1, 
           label=paste0("slope =",signif(summary_lmer$coefficients["Total_rel", "Estimate"], digits =3)),
           color="blue") +
  labs(x="Relative Beta Power", y="Centered Log GAD7", title = "Relative Beta Power across All Visits") 
  
#Print equation
#extract_eq(LMM)


# Merge output into new dataframe for plotting
fitted_vals <- as.matrix(as.numeric(fitted(LMM)))
total_rel <- LMM@frame[["Total_rel"]]
EGA_c <- LMM@frame[["EGA_c"]]
ParticipantID <- LMM@frame[["ParticipantID"]]

plot_data <- data.frame(fitted_vals = fitted_vals, 
                        Total_rel = total_rel, EGA_c = EGA_c, ParticipantID = ParticipantID)

# add in the original EGA values etc. 
merged_data <- merge(plot_data, Plot_data, by = c("ParticipantID", "EGA_c", "Total_rel"))


# Plot Fitted values
ggplot(merged_data, aes(Total_rel, fitted_vals, col=EGA)) +
  geom_point(size = 1.5) +
  geom_abline(intercept = fixef(LMM)["(Intercept)"], slope = fixef(LMM)["Total_rel"], 
              color = "red", linetype = "dashed", linewidth = 1) +
  labs(x = "Total Relative Beta Power", y = "Fitted c_GAD7", title = "Relative Beta Power across Perinatal Period") + 
  annotate(geom="text", x=0.3, y=1, 
           label=paste0("p-value =",signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits =3)),
           color="black") +
  theme_classic() +
  theme(axis.text.x = element_text(family = "sans",color = "black", size = 14),
        axis.text.y = element_text(family = "sans",color = "black", size = 14),
        axis.title.x = element_text(family = "sans",color = "black", size = 14),
        axis.title.y = element_text(family = "sans",color = "black", size = 14))

```

#### 3.2.3 - Delta (perinatal)

```{r}
# Step 1: Filter to Delta Power
#################################################################
Plot_data <- Spec_Meta_data %>% subset(Freq_int_name == "Delta")%>% group_by(ParticipantID) %>%
  filter(n() >= 3) %>%
  ungroup()


# Step 2: Create the Model
#################################################################
LMM <- lmer(loggad7_c ~ Total_rel  + Ethnicity_Hispanic + Race_Black + Healthcare_numeric + EGA_c + (Total_rel|ParticipantID), 
                Plot_data, REML=F)

#sjPlot::tab_model(LMM)
knitr::knit_print(sjPlot::tab_model(LMM))

# Step 3: Plot Fixed Effects of CAT-ANX
#################################################################

# get fixed effects
LMM_effects <- as.data.frame(effects::effect(term= "Total_rel", mod= LMM))

# Summary of Coefficients
summary_lmer <- summary(LMM)

# Merge output into new dataframe for plotting
fitted_vals <- as.matrix(as.numeric(fitted(LMM)))
total_rel <- LMM@frame[["Total_rel"]]
EGA_c <- LMM@frame[["EGA_c"]]
ParticipantID <- LMM@frame[["ParticipantID"]]

plot_data <- data.frame(fitted_vals = fitted_vals, 
                        Total_rel = total_rel, EGA_c = EGA_c, ParticipantID = ParticipantID)

# add in the original EGA values etc. 
merged_data <- merge(plot_data, Plot_data, by = c("ParticipantID", "EGA_c", "Total_rel"))


# Plot Fitted values
# deltaplt<-ggplot(merged_data, aes(Total_rel, fitted_vals, col=EGA)) +
#   geom_point(size = 1.5) +
#   geom_abline(intercept = fixef(LMM)["(Intercept)"], slope = fixef(LMM)["Total_rel"], 
#               color = "red", linetype = "dashed", linewidth = 1) +
#   labs(x = "Relative Delta Power", y = "Centered Log GAD7 Scores", title = "Relative Delta Power across Overall Perinatal Period") + 
#   #annotate(geom="text", x=0.3, y=0.92, 
#         #   label=paste0("p-value =",signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits =3)),
#         #   color="black") +
#   theme_classic() +
#   theme(axis.text.x = element_text(family = "sans",color = "black", size = 14),
#         axis.text.y = element_text(family = "sans",color = "black", size = 14),
#         axis.title.x = element_text(family = "sans",color = "black", size = 14),
#         axis.title.y = element_text(family = "sans",color = "black", size = 14))
# deltaplt
# 
# ggsave(here("Data","deltaplot.png"), plot = deltaplt)

ggplot(merged_data, aes(Total_rel, fitted_vals, col=SplitEGA_c)) +
  geom_point(size = 3.5) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  geom_abline(intercept = fixef(LMM)["(Intercept)"], slope = fixef(LMM)["Total_rel"],
              color = "red", linetype = "dashed", linewidth = 1) +
  labs(x = "Relative Delta Power", y = "Adjusted Log GAD7", title = "Relative Delta Power across Overall Perinatal Period", color = "Scaled EGA") +
 # annotate(geom="text", x=0.3, y=0.92,label=paste0("p-value =",signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits =3)), color="black") +
  theme_classic() +
  theme(axis.text.x = element_text(family = "sans",color = "black", size = 14),
        axis.text.y = element_text(family = "sans",color = "black", size = 14),
        axis.title.x = element_text(family = "sans",color = "black", size = 20),
        axis.title.y = element_text(family = "sans",color = "black", size = 20))+
  ggtitle("")

#ggsave("p.png", p)

##################################################################################
#Plot raw values
ggplot() + 
geom_point(data=Plot_data, aes(x=Total_rel, y=loggad7_c, color = Visit)) + 
  geom_point(data=LMM_effects, aes(x=Total_rel, y=fit), color="blue") +
  geom_line(data=LMM_effects, aes(x=Total_rel, y=fit), color="blue") +
  geom_ribbon(data=LMM_effects, aes(x=Total_rel, ymin=lower, ymax=upper), 
              alpha= 0.3, fill="blue") +
  theme_classic() + 
  annotate(geom="text", x=0.3, y=1.1, 
           label=paste0("p-value =",signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits =3)),
          color="black") +
  annotate(geom="text", x=0.6, y=1.1, 
           label=paste0("slope =",signif(summary_lmer$coefficients["Total_rel", "Estimate"], digits =3)),
           color="blue") +
  labs(x="Relative Delta Power", y="Centered Log GAD7", title = "Relative Delta Power across  Perinatal Period") 
  
#########################################################
#plot adjusted values


#Plot adjusted values
# find the subset of plot data used in the lm.model
Plot_data_subset <- Plot_data[row.names(LMM@frame),]

# find covariate adjusted loggad7_c
loggad7_c_adjusted <- with(Plot_data_subset, {
  loggad7_c - 
  Healthcare_numeric * fixef(LMM)["Healthcare_numeric"] - 
  Ethnicity_Hispanic * fixef(LMM)["Ethnicity_Hispanic"] - 
  Race_Black * fixef(LMM)["Race_Black"] - 
  EGA_c * fixef(LMM)["EGA_c"]
})
# construct a dataframe with the adjusted values and the SplitEGA_c used for the point color scheme
adjusted <- data.frame(
  loggad7_c_adjusted = loggad7_c_adjusted,
  Total_rel = Plot_data_subset$Total_rel,
  SplitEGA_c = Plot_data_subset$SplitEGA_c  
)

# plot based on adjusted loggad7_c
 ggplot(adjusted, aes(x = Total_rel, y = loggad7_c_adjusted)) + 
   
    geom_point(data = adjusted, aes(x = Total_rel, y = loggad7_c_adjusted, col = adjusted$SplitEGA_c), size = 5, stroke = NA) +
   
    stat_smooth(method = "lm", col = "red", linetype = "dashed", linewidth = 1) +
    
   
# annotate(geom="text", x=0.3, y=0.9, label=paste0("p-value =",signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits =3)), color="goldenrod4") +
#  annotate(geom="text", x=0.6, y=0.9, label=paste0("slope =",signif(summary_lmer$coefficients["Total_rel", "Estimate"], digits =3)), color="goldenrod4") +
   theme_classic()  + theme(axis.text=element_text(size=14), axis.title=element_text(size=20)) +
   
labs(x = "Relative Delta Power", y = "Adjusted GAD7", title = "Relative Delta Power across Overall Perinatal Period", color = "Scaled EGA")+
   
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")) + ylim(0,1)
#Print equation
#extract_eq(LMM)
```



#### 3.2.4 - Theta (perinatal)

```{r}
# Step 1: Filter to Theta Power
#################################################################
Plot_data <- Spec_Meta_data %>% subset(Freq_int_name == "Theta")%>% group_by(ParticipantID) %>%
  filter(n() >= 3) %>%
  ungroup()


# Step 2: Create the Model
#################################################################
LMM <- lmer(loggad7_c ~ Total_rel  + Ethnicity_Hispanic + Race_Black + Healthcare_numeric + EGA_c  + (Total_rel|ParticipantID), 
                Plot_data, REML=F)

#sjPlot::tab_model(LMM)
knitr::knit_print(sjPlot::tab_model(LMM))

# Step 3: Plot Fixed Effects of CAT-ANX
#################################################################

# get fixed effects
LMM_effects <- as.data.frame(effects::effect(term= "Total_rel", mod= LMM))

# summary to pull coefficient
summary_lmer <- summary(LMM)

ggplot() + 
geom_point(data=Plot_data, aes(x=Total_rel, y=loggad7_c, color = Visit)) + 
  geom_point(data=LMM_effects, aes(x=Total_rel, y=fit), color="blue") +
  geom_line(data=LMM_effects, aes(x=Total_rel, y=fit), color="blue") +
  geom_ribbon(data=LMM_effects, aes(x=Total_rel, ymin=lower, ymax=upper), 
              alpha= 0.3, fill="blue") +
  theme_minimal() + 
  annotate(geom="text", x=0.05, y=1, 
           label=paste0("p-value =",signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits =3)),
           color="black") +
  annotate(geom="text", x=0.2, y=1, 
           label=paste0("slope =",signif(summary_lmer$coefficients["Total_rel", "Estimate"], digits =3)),
           color="blue") +
  labs(x="Relative Theta Power", y="Log GAD7 Scores", title = "Relative Theta Power across All Visits") 
  
#Print equation
extract_eq(LMM)

```

#### 3.2.5 - Gamma (perinatal)

```{r}
# Step 1: Filter to Gamma Power
#################################################################
Plot_data <- Spec_Meta_data %>% subset(Freq_int_name == "Gamma")%>% group_by(ParticipantID) %>%
  filter(n() >= 3) %>%
  ungroup()


# Step 2: Create the Model
#################################################################
LMM <- lmer(loggad7_c ~ Total_rel + Ethnicity_Hispanic + Race_Black + Healthcare_numeric + EGA_c + (Total_rel|ParticipantID), 
                Plot_data, REML=F)
#sjPlot::tab_model(LMM, file = here("Output","Gamma_LMM.csv"))
knitr::knit_print(sjPlot::tab_model(LMM))


# Step 3: Plot Fixed Effects of CAT-ANX
#################################################################

# get fixed effects
LMM_effects <- as.data.frame(effects::effect(term= "Total_rel", mod= LMM))

# summary to pull coefficient
summary_lmer <- summary(LMM)

ggplot() + 
geom_point(data=Plot_data, aes(x=Total_rel, y=loggad7_c, color = Visit)) + 
  geom_point(data=LMM_effects, aes(x=Total_rel, y=fit), color="blue") +
  geom_line(data=LMM_effects, aes(x=Total_rel, y=fit), color="blue") +
  geom_ribbon(data=LMM_effects, aes(x=Total_rel, ymin=lower, ymax=upper), 
              alpha= 0.3, fill="blue") +
  theme_minimal() + 
  annotate(geom="text", x=0.05, y=1, 
           label=paste0("p-value =",signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits =3)),
           color="black") +
  annotate(geom="text", x=0.15, y=1, 
           label=paste0("slope =",signif(summary_lmer$coefficients["Total_rel", "Estimate"], digits =3)),
           color="blue") +
  labs(x="Relative Gamma Power", y="Log GAD7 Scores", title = "Relative Gamma Power across All Visits") 
  
#Print equation
extract_eq(LMM)

```

#### 3.2.6 - Alpha wave (antenatal)

For this linear mixed model, allowing Total_rel slope to vary participant to participant

```{r}
# Step 1: Filter to Alpha Power
#################################################################
Plot_data <- Spec_Meta_data %>% subset(Freq_int_name == "Alpha") %>% group_by(ParticipantID) %>%
  ungroup() %>% subset(!Visit == "PP")



# Step 2: Create the Model
#################################################################
LMM <- lmer(loggad7_c ~ Total_rel   + Ethnicity_Hispanic + Race_Black + Healthcare_numeric + EGA_c + (Total_rel|ParticipantID), 
                Plot_data, REML=F)
  #previous model lmer (loggad7 ~ Total_rel + Age + EGA+ Race_Black + Ethnicity_Hispanic + Healthcare_numeric + (Total_rel|ParticipantID), Plot_data, REML=F)

#sjPlot::tab_model(LMM)
sjPlot::tab_model(LMM)
knitr::knit_print(sjPlot::tab_model(LMM))

# Step 3: Plot Fixed Effects of CAT-ANX
#################################################################

# get fixed effects
LMM_effects <- as.data.frame(effects::effect(term= "Total_rel", mod= LMM))

# Step 3: Plot Fixed Effects of PHQ9_c
#################################################################

# Summary of Coefficients
summary_lmer <- summary(LMM)

# Merge output into new dataframe for plotting
fitted_vals <- as.matrix(as.numeric(fitted(LMM)))
total_rel <- LMM@frame[["Total_rel"]]
EGA_c <- LMM@frame[["EGA_c"]]
ParticipantID <- LMM@frame[["ParticipantID"]]

plot_data <- data.frame(fitted_vals = fitted_vals, 
                        Total_rel = total_rel, EGA_c = EGA_c, ParticipantID = ParticipantID)

# add in the original EGA values etc. 
merged_data <- merge(plot_data, Plot_data, by = c("ParticipantID", "EGA_c", "Total_rel"))


# Plot Fitted values
ggplot(merged_data, aes(Total_rel, fitted_vals, col=EGA)) +
  geom_point(size = 1.5) +
  geom_abline(intercept = fixef(LMM)["(Intercept)"], slope = fixef(LMM)["Total_rel"], 
              color = "red", linetype = "dashed", linewidth = 1) +
  labs(x = "Total Relative Alpha Power", y = "Fitted c_GAD7", title = "Relative Alpha Power across Perinatal Period") + 
  annotate(geom="text", x=0.3, y=1, 
           label=paste0("p-value =",signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits =3)),
           color="black") +
  theme_classic() +
  theme(axis.text.x = element_text(family = "sans",color = "black", size = 14),
        axis.text.y = element_text(family = "sans",color = "black", size = 14),
        axis.title.x = element_text(family = "sans",color = "black", size = 14),
        axis.title.y = element_text(family = "sans",color = "black", size = 14))

#Plot adjusted values
# find the subset of plot data used in the lm.model
Plot_data_subset <- Plot_data[row.names(LMM@frame),]

# find covariate adjusted loggad7_c
loggad7_c_adjusted <- with(Plot_data_subset, {
  loggad7_c - 
  Healthcare_numeric * fixef(LMM)["Healthcare_numeric"] - 
  Ethnicity_Hispanic * fixef(LMM)["Ethnicity_Hispanic"] - 
  Race_Black * fixef(LMM)["Race_Black"] - 
  EGA_c * fixef(LMM)["EGA_c"]
})
# construct a dataframe with the adjusted values and the SplitEGA_c used for the point color scheme
adjusted <- data.frame(
  loggad7_c_adjusted = loggad7_c_adjusted,
  Total_rel = Plot_data_subset$Total_rel,
  SplitEGA_c = Plot_data_subset$SplitEGA_c  
)

# plot based on adjusted loggad7_c
 ggplot(adjusted, aes(x = Total_rel, y = loggad7_c_adjusted)) + 
   
    geom_point(data = adjusted, aes(x = Total_rel, y = loggad7_c_adjusted, col = adjusted$SplitEGA_c), size = 5, stroke = NA) +
   
    stat_smooth(method = "lm", col = "red", linetype = "dashed", linewidth = 1) +
    
   
# annotate(geom="text", x=0.3, y=1.1, label=paste0("p-value =",signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits =3)), color="goldenrod4") +
 # annotate(geom="text", x=0.6, y=1.1, label=paste0("slope =",signif(summary_lmer$coefficients["Total_rel", "Estimate"], digits =3)), color="goldenrod4") + 
   theme_classic()  +
   theme(axis.text=element_text(size=14), axis.title=element_text(size=20)) +
   
labs(x = "Relative Alpha Power", y = "Adjusted GAD7", title = "Relative Alpha Power across Antenatal Period", color = "Scaled EGA")+
   
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")) #+ ylim(0,1.1)



```

#### 3.2.7 - Beta (antenatal)

```{r}
# Step 1: Filter to Beta Power
#################################################################
Plot_data <- Spec_Meta_data %>% subset(Freq_int_name == "Beta") %>% group_by(ParticipantID) %>%
  filter(n() >= 3) %>%
  ungroup()%>% subset(!Visit == "PP")


# Step 2: Create the Model
#################################################################
LMM <- lmer(loggad7_c ~ Total_rel  + Ethnicity_Hispanic  +  Race_Black + Healthcare_numeric + EGA_c + (Total_rel|ParticipantID), 
                Plot_data, REML=F)

sjPlot::tab_model(LMM)
knitr::knit_print(sjPlot::tab_model(LMM))

# Step 3: Plot Fixed Effects of CAT-ANX
#################################################################

# get fixed effects
LMM_effects <- as.data.frame(effects::effect(term= "Total_rel", mod= LMM))

# summary to pull coefficient
summary_lmer <- summary(LMM)
##
# Merge output into new dataframe for plotting
fitted_vals <- as.matrix(as.numeric(fitted(LMM)))
total_rel <- LMM@frame[["Total_rel"]]
EGA_c <- LMM@frame[["EGA_c"]]
ParticipantID <- LMM@frame[["ParticipantID"]]

plot_data <- data.frame(fitted_vals = fitted_vals, 
                        Total_rel = total_rel, EGA_c = EGA_c, ParticipantID = ParticipantID)
merged_data <- merge(plot_data, Plot_data, by = c("ParticipantID", "EGA_c", "Total_rel"))
##
ggplot(merged_data, aes(Total_rel, fitted_vals, col=SplitEGA_c)) +
  geom_point(size = 1.5) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +

  #scale_color_gradientn(
#    colors = c("lightblue", "darkblue", "orange"),
#    values = c(0, 0.9,1),
   # limits = c(0,1.5)) +
  geom_abline(intercept = fixef(LMM)["(Intercept)"], slope = fixef(LMM)["Total_rel"], 
              color = "red", linetype = "dashed", linewidth = 1) +
  labs(x = "Relative Beta Power", y = "Centered Log GAD7", title = "Relative Beta Power across Antenatal Period", color = "Scaled EGA") + 
  annotate(geom="text", x=0.3, y=1, 
           label=paste0("p-value =",signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits =3)),
           color="black") +
  theme_classic() +
  theme(axis.text.x = element_text(family = "sans",color = "black", size = 14),
        axis.text.y = element_text(family = "sans",color = "black", size = 14),
        axis.title.x = element_text(family = "sans",color = "black", size = 14),
        axis.title.y = element_text(family = "sans",color = "black", size = 14))
###

ggplot() + 
geom_point(data=Plot_data, aes(x=Total_rel, y=loggad7_c, color = Visit)) + 
  geom_point(data=LMM_effects, aes(x=Total_rel, y=fit), color="blue") +
  geom_line(data=LMM_effects, aes(x=Total_rel, y=fit), color="blue") +
  geom_ribbon(data=LMM_effects, aes(x=Total_rel, ymin=lower, ymax=upper), 
              alpha= 0.3, fill="blue") +
  theme_minimal() + 
  annotate(geom="text", x=0.1, y=1, 
           label=paste0("p-value =",signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits =3)),
           color="black") +
  annotate(geom="text", x=0.3, y=1, 
           label=paste0("slope =",signif(summary_lmer$coefficients["Total_rel", "Estimate"], digits =3)),
           color="blue") +
  labs(x="Relative Beta Power", y="Log GAD7 Scores", title = "Relative Beta Power across All Visits") 
  
#Print equation
#extract_eq(LMM)

```

#### 3.2.8 - Delta (antenatal)

```{r}
# Step 1: Filter to Delta Power
#################################################################
Plot_data <- Spec_Meta_data %>% subset(Freq_int_name == "Delta")%>% group_by(ParticipantID) %>%
  #filter(n() >= 3) %>%
  ungroup()%>% subset(!Visit == "PP")


# Step 2: Create the Model
#################################################################
LMM <- lmer(loggad7_c ~ Total_rel + Ethnicity_Hispanic + Race_Black + Healthcare_numeric + EGA_c + (Total_rel|ParticipantID), 
                Plot_data, REML=F)

sjPlot::tab_model(LMM)
knitr::knit_print(sjPlot::tab_model(LMM))

# Step 3: Plot Fixed Effects of CAT-ANX
#################################################################

# get fixed effects
LMM_effects <- as.data.frame(effects::effect(term= "Total_rel", mod= LMM))

# Summary of Coefficients
summary_lmer <- summary(LMM)

# Merge output into new dataframe for plotting
fitted_vals <- as.matrix(as.numeric(fitted(LMM)))
total_rel <- LMM@frame[["Total_rel"]]
EGA_c <- LMM@frame[["EGA_c"]]
ParticipantID <- LMM@frame[["ParticipantID"]]

plot_data <- data.frame(fitted_vals = fitted_vals, 
                        Total_rel = total_rel, EGA_c = EGA_c, ParticipantID = ParticipantID)

# add in the original EGA values etc. 
merged_data <- merge(plot_data, Plot_data, by = c("ParticipantID", "EGA_c", "Total_rel"))


# Plot Fitted values
ggplot(merged_data, aes(Total_rel, fitted_vals, col=EGA)) +
  geom_point(size = 1.5) +
  geom_abline(intercept = fixef(LMM)["(Intercept)"], slope = fixef(LMM)["Total_rel"], 
              color = "red", linetype = "dashed", linewidth = 1) +
  labs(x = "Total Relative Delta Power", y = "Fitted c_GAD7", title = "Relative Delta Power across Perinatal Period") + 
  annotate(geom="text", x=0.3, y=0.92, 
           label=paste0("p-value =",signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits =3)),
           color="black") +
  theme_classic() +
  theme(axis.text.x = element_text(family = "sans",color = "black", size = 14),
        axis.text.y = element_text(family = "sans",color = "black", size = 14),
        axis.title.x = element_text(family = "sans",color = "black", size = 14),
        axis.title.y = element_text(family = "sans",color = "black", size = 14))

#Print equation
#extract_eq(LMM)


# find the subset of plot data used in the lm.model
Plot_data_subset <- Plot_data[row.names(LMM@frame),]

# find covariate adjusted loggad7_c
loggad7_c_adjusted <- with(Plot_data_subset, {
  loggad7_c - 
  Healthcare_numeric * fixef(LMM)["Healthcare_numeric"] - 
  Ethnicity_Hispanic * fixef(LMM)["Ethnicity_Hispanic"] - 
  Race_Black * fixef(LMM)["Race_Black"] - 
  EGA_c * fixef(LMM)["EGA_c"]
})
# construct a dataframe with the adjusted values and the SplitEGA_c used for the point color scheme
adjusted <- data.frame(
  loggad7_c_adjusted = loggad7_c_adjusted,
  Total_rel = Plot_data_subset$Total_rel,
  SplitEGA_c = Plot_data_subset$SplitEGA_c  
)

# plot based on adjusted loggad7_c
 ggplot(adjusted, aes(x = Total_rel, y = loggad7_c_adjusted)) + 
   
    geom_point(data = adjusted, aes(x = Total_rel, y = loggad7_c_adjusted, col = adjusted$SplitEGA_c), size = 5, stroke = NA) +
   
    stat_smooth(method = "lm", col = "red", linetype = "dashed", linewidth = 1) +
    
   
# annotate(geom="text", x=0.3, y=1.1, label=paste0("p-value =",signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits =3)), color="goldenrod4") +
 # annotate(geom="text", x=0.6, y=1.1, label=paste0("slope =",signif(summary_lmer$coefficients["Total_rel", "Estimate"], digits =3)), color="goldenrod4") + 
   theme_classic()  +
   theme(axis.text=element_text(size=14), axis.title=element_text(size=20)) +
   
labs(x = "Relative Delta Power", y = "Adjusted GAD7", title = "Relative Delta Power across Antenatal Period", color = "Scaled EGA")+
   
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")) #+ ylim(0,1.1)


```



#### 3.2.9 - Theta (antenatal)

```{r}
# Step 1: Filter to Theta Power
#################################################################
Plot_data <- Spec_Meta_data %>% subset(Freq_int_name == "Theta")%>% group_by(ParticipantID) %>%
  filter(n() >= 3) %>%
  ungroup()%>% subset(!Visit == "PP")


# Step 2: Create the Model
#################################################################
LMM <- lmer(loggad7_c ~ Total_rel  + Ethnicity_Hispanic + Race_Black + Healthcare_numeric + EGA_c  + (Total_rel|ParticipantID), 
                Plot_data, REML=F)

#sjPlot::tab_model(LMM)
knitr::knit_print(sjPlot::tab_model(LMM))

# Step 3: Plot Fixed Effects of CAT-ANX
#################################################################

# get fixed effects
LMM_effects <- as.data.frame(effects::effect(term= "Total_rel", mod= LMM))

# summary to pull coefficient
summary_lmer <- summary(LMM)

ggplot() + 
geom_point(data=Plot_data, aes(x=Total_rel, y=loggad7_c, color = Visit)) + 
  geom_point(data=LMM_effects, aes(x=Total_rel, y=fit), color="blue") +
  geom_line(data=LMM_effects, aes(x=Total_rel, y=fit), color="blue") +
  geom_ribbon(data=LMM_effects, aes(x=Total_rel, ymin=lower, ymax=upper), 
              alpha= 0.3, fill="blue") +
  theme_minimal() + 
  annotate(geom="text", x=0.05, y=1, 
           label=paste0("p-value =",signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits =3)),
           color="black") +
  annotate(geom="text", x=0.2, y=1, 
           label=paste0("slope =",signif(summary_lmer$coefficients["Total_rel", "Estimate"], digits =3)),
           color="blue") +
  labs(x="Relative Theta Power", y="Log GAD7 Scores", title = "Relative Theta Power across All Visits") 
  
#Print equation
extract_eq(LMM)

```

#### 3.2.10 - Gamma (antenatal)

```{r}
# Step 1: Filter to Gamma Power
#################################################################
Plot_data <- Spec_Meta_data %>% subset(Freq_int_name == "Gamma")%>% group_by(ParticipantID) %>%
  filter(n() >= 3) %>%
  ungroup()%>% subset(!Visit == "PP")


# Step 2: Create the Model
#################################################################
LMM <- lmer(loggad7_c ~ Total_rel  + Ethnicity_Hispanic + Race_Black + Healthcare_numeric + EGA_c + (Total_rel|ParticipantID), 
                Plot_data, REML=F)
#sjPlot::tab_model(LMM, file = here("Output","Gamma_LMM.csv"))
knitr::knit_print(sjPlot::tab_model(LMM))


# Step 3: Plot Fixed Effects of CAT-ANX
#################################################################

# get fixed effects
LMM_effects <- as.data.frame(effects::effect(term= "Total_rel", mod= LMM))

# summary to pull coefficient
summary_lmer <- summary(LMM)

ggplot() + 
geom_point(data=Plot_data, aes(x=Total_rel, y=loggad7_c, color = Visit)) + 
  geom_point(data=LMM_effects, aes(x=Total_rel, y=fit), color="blue") +
  geom_line(data=LMM_effects, aes(x=Total_rel, y=fit), color="blue") +
  geom_ribbon(data=LMM_effects, aes(x=Total_rel, ymin=lower, ymax=upper), 
              alpha= 0.3, fill="blue") +
  theme_minimal() + 
  annotate(geom="text", x=0.05, y=1, 
           label=paste0("p-value =",signif(summary_lmer$coefficients["Total_rel", "Pr(>|t|)"], digits =3)),
           color="black") +
  annotate(geom="text", x=0.15, y=1, 
           label=paste0("slope =",signif(summary_lmer$coefficients["Total_rel", "Estimate"], digits =3)),
           color="blue") +
  labs(x="Relative Gamma Power", y="Log GAD7 Scores", title = "Relative Gamma Power across All Visits") 
  
#Print equation
extract_eq(LMM)

```


### 3.3 - Predict T3 GAD7 from T1 Waves

#### 3.3.1 - T1 Alpha predicts T3 GAD7
```{r}
# Make a dataframe with the summarized data in it
#################################################
# Wave change
T1_Wave_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Alpha") %>%
  filter(Visit %in% c("T1")) %>%
  group_by(ParticipantID) %>%
  summarize(
    Waves = Total_rel[Visit == "T1"])
# add in GAD7 scores at T1
T3_GAD7 <-  Spec_Meta_data %>%
  subset(Visit == "T3") %>%
  dplyr::select(ParticipantID, loggad7_c,
                Healthcare_numeric, Race_Black,
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% T1_Wave_data$ParticipantID) %>%
  unique()
# Merge the wave change and depression data together
#################################################
Plot_data <- merge(T1_Wave_data, T3_GAD7, by = "ParticipantID")
# Linear Model
#################################################
lm.model <- lm(loggad7_c~ Waves+Healthcare_numeric+Race_Black+Ethnicity_Hispanic,
            data = Plot_data)
summary(lm.model)
lm.model$SplitEGA_c<-Plot_data[row.names(model.frame(lm.model)),]$SplitEGA_c

ggplotRegression(lm.model)   +
  theme_classic() +
  xlab("T1 Alpha Relative Power") +
  ylab("T3 Scaled GAD7") +
  theme(axis.text.x =  element_text(family = "sans", color = "black", size =14),
        axis.text.y =  element_text(family = "sans", color = "black", size =14),
        axis.title.x =  element_text(family = "sans", color = "black", size =20),
        axis.title.y =  element_text(family = "sans", color = "black", size =20)) +
  geom_point(data = lm.model , aes(x = lm.model$model[[2]], y = fitted(lm.model), col = lm.model$SplitEGA_c), size = 5, stroke = NA)  +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  labs (color = "Scaled EGA")



```

#### 3.3.2 - T1 Beta predicts T3 GAD7
```{r}
# Make a dataframe with the summarized data in it
#################################################
# Wave change
T1_Wave_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Beta") %>%
  filter(Visit %in% c("T1")) %>%
  group_by(ParticipantID) %>%
  summarize(
    T1_Waves = Total_rel[Visit == "T1"])
# add in GAD7 scores at T1
T3_GAD7 <-  Spec_Meta_data %>%
  subset(Visit == "T3") %>%
  dplyr::select(ParticipantID, loggad7_c,
                Healthcare_numeric, Race_Black,
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% T1_Wave_data$ParticipantID) %>%
  unique()
# Merge the wave change and depression data together
#################################################
Plot_data <- merge(T1_Wave_data, T3_GAD7, by = "ParticipantID")
# Linear Model
#################################################
lm.model <- lm(loggad7_c~ T1_Waves+Healthcare_numeric+Race_Black+Ethnicity_Hispanic,
            data = Plot_data)
summary(lm.model)
ggplotRegression(lm.model)   +
  theme_classic() +
  xlab("T1 Beta Relative Power") +
  ylab("T3 Scaled GAD7") +
  theme(axis.text.x =  element_text(family = "sans", color = "black", size =14),
        axis.text.y =  element_text(family = "sans", color = "black", size =14),
        axis.title.x =  element_text(family = "sans", color = "black", size =14),
        axis.title.y =  element_text(family = "sans", color = "black", size =14)) +
  geom_point(data = Plot_data, aes(x = T1_Waves,
                                   y = loggad7_c, color = SplitEGA_c)) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  labs (color = "Scaled EGA")


```

#### 3.3.3 - T1 Delta predicts T3 GAD7
```{r}
# Make a dataframe with the summarized data in it
#################################################
# Wave change
T1_Wave_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Delta") %>%
  filter(Visit %in% c("T1")) %>%
  group_by(ParticipantID) %>%
  summarize(
    T1_Waves = Total_rel[Visit == "T1"])
# add in GAD7 scores at T1
T3_GAD7 <-  Spec_Meta_data %>%
  subset(Visit == "T3") %>%
  dplyr::select(ParticipantID, loggad7_c,
                Healthcare_numeric, Race_Black,
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% T1_Wave_data$ParticipantID) %>%
  unique()
# Merge the wave change and depression data together
#################################################
Plot_data <- merge(T1_Wave_data, T3_GAD7, by = "ParticipantID")
# Linear Model
#################################################
lm.model <- lm(loggad7_c~ T1_Waves+Healthcare_numeric+Race_Black+Ethnicity_Hispanic,
            data = Plot_data)

summary(lm.model)
lm.model$SplitEGA_c<-Plot_data[row.names(model.frame(lm.model)),]$SplitEGA_c
ggplotRegression(lm.model)   +
  theme_classic() +
  xlab("<16 GWs Relative Delta Power") +
  ylab("36 GWs Adjusted GAD-7") +
  theme(axis.text.x =  element_text(family = "sans", color = "black", size =14),
        axis.text.y =  element_text(family = "sans", color = "black", size =14),
        axis.title.x =  element_text(family = "sans", color = "black", size =20),
        axis.title.y =  element_text(family = "sans", color = "black", size =20)) +
  geom_point(data = lm.model , aes(x = lm.model$model[[2]], y = fitted(lm.model), col = lm.model$SplitEGA_c), size = 5, stroke = NA)  +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  labs (color = "Scaled EGA")

#############################################################################
Plot_data_subset <- Plot_data[row.names(model.frame(lm.model)),]

# Find covariate adjusted loggad7_c
loggad7_c_adjusted <- with(Plot_data_subset, {
loggad7_c - 
 Healthcare_numeric * coef(lm.model)["Healthcare_numeric"] - 
 Ethnicity_Hispanic * coef(lm.model)["Ethnicity_Hispanic"] - 
 Race_Black * coef(lm.model)["Race_Black"]
})
#construct a dataframe with the adjusted values and the SplitEGA_c used for the point color scheme
adjusted <- data.frame(
  loggad7_c_adjusted = loggad7_c_adjusted,
  T1_Waves = Plot_data_subset$T1_Waves,
  SplitEGA_c = Plot_data_subset$SplitEGA_c  
)

#Plot!
 ggplot(adjusted, aes(x = T1_Waves, y = loggad7_c_adjusted)) + 
    geom_point(data = adjusted, aes(x = T1_Waves, y = loggad7_c_adjusted, col = adjusted$SplitEGA_c), size = 5, stroke = NA) +
    stat_smooth(method = "lm", col = "red", linetype = "dashed", linewidth = 1) +
    labs(title = paste("Adj R2 = ",signif(summary(lm.model)$adj.r.squared, 5),
                     "Intercept =",signif(lm.model$coef[[1]],5 ),
                     " Slope =",signif(lm.model$coef[[2]], 5),
                     " P =",signif(summary(lm.model)$coef[2,4], 5))) + theme_classic() + 
  xlab("<16 GWs Relative Delta Power") +
  ylab("36 GWs Adjusted GAD-7") +
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20), face = "bold") +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA") #+    ylim(-1, 1)



```


#### 3.3.4 - T1 Theta predicts T3 GAD7
```{r}
# Make a dataframe with the summarized data in it
#################################################
# Wave change
T3_Wave_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Theta") %>%
  filter(Visit %in% c("T3")) %>%
  group_by(ParticipantID) %>%
  summarize(
    T3_Waves = Total_rel[Visit == "T3"])
# add in GAD7 scores at T1
T1_GAD7 <-  Spec_Meta_data %>%
  subset(Visit == "T1") %>%
  dplyr::select(ParticipantID, loggad7_c,
                Healthcare_numeric, Race_Black,
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% T3_Wave_data$ParticipantID) %>%
  unique()
# Merge the wave change and depression data together
#################################################
Plot_data <- merge(T3_Wave_data, T1_GAD7, by = "ParticipantID")
# Linear Model
#################################################
lm.model <- lm(loggad7_c~ T3_Waves+Healthcare_numeric+Race_Black+Ethnicity_Hispanic,
            data = Plot_data)
summary(lm.model)
ggplotRegression(lm.model)   +
  theme_classic() +
  xlab("T1 Theta Relative Power") +
  ylab("T3 Scaled GAD7") +
  theme(axis.text.x =  element_text(family = "sans", color = "black", size =14),
        axis.text.y =  element_text(family = "sans", color = "black", size =14),
        axis.title.x =  element_text(family = "sans", color = "black", size =14),
        axis.title.y =  element_text(family = "sans", color = "black", size =14)) +
  geom_point(data = Plot_data, aes(x = T3_Waves,
                                   y = loggad7_c, color = SplitEGA_c)) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  labs (color = "Scaled EGA")
```

#### 3.3.5 - T1 Gamma predicts T3 GAD7
```{r}
# Make a dataframe with the summarized data in it
#################################################
# Wave change
T3_Wave_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Gamma") %>%
  filter(Visit %in% c("T3")) %>%
  group_by(ParticipantID) %>%
  summarize(
    T3_Waves = Total_rel[Visit == "T3"])
# add in GAD7 scores at T1
T1_GAD7 <-  Spec_Meta_data %>%
  subset(Visit == "T1") %>%
  dplyr::select(ParticipantID, loggad7_c,
                Healthcare_numeric, Race_Black,
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% T3_Wave_data$ParticipantID) %>%
  unique()
# Merge the wave change and depression data together
#################################################
Plot_data <- merge(T3_Wave_data, T1_GAD7, by = "ParticipantID")
# Linear Model
#################################################
lm.model <- lm(loggad7_c~ T3_Waves+Healthcare_numeric+Race_Black+Ethnicity_Hispanic,
            data = Plot_data)
summary(lm.model)
ggplotRegression(lm.model)   +
  theme_classic() +
  xlab("T1 Gamma Relative Power") +
  ylab("T3 Scaled GAD7") +
  theme(axis.text.x =  element_text(family = "sans", color = "black", size =14),
        axis.text.y =  element_text(family = "sans", color = "black", size =14),
        axis.title.x =  element_text(family = "sans", color = "black", size =14),
        axis.title.y =  element_text(family = "sans", color = "black", size =14)) +
  geom_point(data = Plot_data, aes(x = T3_Waves,
                                   y = loggad7_c, color = SplitEGA_c)) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  labs (color = "Scaled EGA")
```


### 3.4 - Predict PP GAD7 from T1 Waves

#### 3.4.1- T1 Alpha predicts PP GAD7
```{r}
# Make a dataframe with the summarized data in it
#################################################
# Wave change
T1_Wave_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Alpha") %>%
  filter(Visit %in% c("T1")) %>%
  group_by(ParticipantID) %>%
  summarize(
    T1_Waves = Total_rel[Visit == "T1"])

# add in GAD7 scores at PP
PP_GAD7 <-  Spec_Meta_data %>%
  subset(Visit == "PP") %>%
  dplyr::select(ParticipantID, loggad7_c,
                Healthcare_numeric, Race_Black,
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% T1_Wave_data$ParticipantID) %>%
  unique()
# Merge the wave change and depression data together
#################################################
Plot_data <- merge(T1_Wave_data, PP_GAD7, by = "ParticipantID")
# Linear Model
#################################################
lm.model <- lm(loggad7_c~ T1_Waves+Healthcare_numeric+Race_Black+Ethnicity_Hispanic,
            data = Plot_data)
summary(lm.model)
ggplotRegression(lm.model)   +
  theme_classic() +
  xlab("T1 Alpha Relative Power") +
  ylab("PP Scaled GAD7") +
  theme(axis.text.x =  element_text(family = "sans", color = "black", size =14),
        axis.text.y =  element_text(family = "sans", color = "black", size =14),
        axis.title.x =  element_text(family = "sans", color = "black", size =14),
        axis.title.y =  element_text(family = "sans", color = "black", size =14)) +
  geom_point(data = Plot_data, aes(x = T1_Waves,
                                   y = loggad7_c, color = SplitEGA_c)) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  labs (color = "Scaled EGA")
```


#### 3.4.2-  T1 Beta predicts PP GAD7
```{r}
# Make a dataframe with the summarized data in it
#################################################
# Wave change
T1_Wave_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Beta") %>%
  filter(Visit %in% c("T1")) %>%
  group_by(ParticipantID) %>%
  summarize(
    T1_Waves = Total_rel[Visit == "T1"])
# add in GAD7 scores at T1
PP_GAD7 <-  Spec_Meta_data %>%
  subset(Visit == "PP") %>%
  dplyr::select(ParticipantID, loggad7_c,
                Healthcare_numeric, Race_Black,
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% T1_Wave_data$ParticipantID) %>%
  unique()
# Merge the wave change and depression data together
#################################################
Plot_data <- merge(T1_Wave_data, PP_GAD7, by = "ParticipantID")
# Linear Model
#################################################
lm.model <- lm(loggad7_c~ T1_Waves+Healthcare_numeric+Race_Black+Ethnicity_Hispanic,
            data = Plot_data)
summary(lm.model)
ggplotRegression(lm.model)   +
  theme_classic() +
  xlab("T1 Beta Relative Power") +
  ylab("PP Scaled GAD7") +
  theme(axis.text.x =  element_text(family = "sans", color = "black", size =14),
        axis.text.y =  element_text(family = "sans", color = "black", size =14),
        axis.title.x =  element_text(family = "sans", color = "black", size =14),
        axis.title.y =  element_text(family = "sans", color = "black", size =14)) +
  geom_point(data = Plot_data, aes(x = T1_Waves,
                                   y = loggad7_c, color = SplitEGA_c)) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  labs (color = "Scaled EGA")
```



#### 3.4.3 -  T1 Delta predicts PP GAD7
```{r}
# Make a dataframe with the summarized data in it
#################################################
# Wave change
T1_Wave_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Delta") %>%
  filter(Visit %in% c("T1")) %>%
  group_by(ParticipantID) %>%
  summarize(
    T1_Waves = Total_rel[Visit == "T1"])
# add in GAD7 scores at T1
PP_GAD7 <-  Spec_Meta_data %>%
  subset(Visit == "PP") %>%
  dplyr::select(ParticipantID, loggad7_c,
                Healthcare_numeric, Race_Black,
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% T1_Wave_data$ParticipantID) %>%
  unique()
# Merge the wave change and depression data together
#################################################
Plot_data <- merge(T1_Wave_data, PP_GAD7, by = "ParticipantID")
# Linear Model
#################################################
lm.model <- lm(loggad7_c~ T1_Waves+Healthcare_numeric+Race_Black+Ethnicity_Hispanic,
            data = Plot_data)
summary(lm.model)
ggplotRegression(lm.model)   +
  theme_classic() +
  xlab("<16 GWs Delta Relative Power") +
  ylab("36 GWs Scaled GAD7") +
  theme(axis.text.x =  element_text(family = "sans", color = "black", size =14),
        axis.text.y =  element_text(family = "sans", color = "black", size =14),
        axis.title.x =  element_text(family = "sans", color = "black", size =14),
        axis.title.y =  element_text(family = "sans", color = "black", size =14)) +
  geom_point(data = Plot_data, aes(x = T1_Waves,
                                   y = loggad7_c, color = SplitEGA_c)) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  labs (color = "Scaled EGA")
```


#### 3.4.4 - T1 Theta predicts PP GAD7
```{r}
# Make a dataframe with the summarized data in it
#################################################
# Wave change
PP_Wave_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Theta") %>%
  filter(Visit %in% c("PP")) %>%
  group_by(ParticipantID) %>%
  summarize(
    PP_Waves = Total_rel[Visit == "PP"])
# add in GAD7 scores at T1
T1_GAD7 <-  Spec_Meta_data %>%
  subset(Visit == "T1") %>%
  dplyr::select(ParticipantID, loggad7_c,
                Healthcare_numeric, Race_Black,
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% T1_Wave_data$ParticipantID) %>%
  unique()
# Merge the wave change and depression data together
#################################################
Plot_data <- merge(PP_Wave_data, T1_GAD7, by = "ParticipantID")
# Linear Model
#################################################
lm.model <- lm(loggad7_c~ PP_Waves+Healthcare_numeric+Race_Black+Ethnicity_Hispanic,
            data = Plot_data)
summary(lm.model)
ggplotRegression(lm.model)   +
  theme_classic() +
  xlab("T1 Theta Relative Power") +
  ylab("PP Scaled GAD7") +
  theme(axis.text.x =  element_text(family = "sans", color = "black", size =14),
        axis.text.y =  element_text(family = "sans", color = "black", size =14),
        axis.title.x =  element_text(family = "sans", color = "black", size =14),
        axis.title.y =  element_text(family = "sans", color = "black", size =14)) +
  geom_point(data = Plot_data, aes(x = PP_Waves,
                                   y = loggad7_c, color = SplitEGA_c)) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  labs (color = "Scaled EGA")
```

#### 3.4.5 - T1 Gamma predicts PP GAD7
```{r}
# Make a dataframe with the summarized data in it
#################################################
# Wave change
PP_Wave_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Gamma") %>%
  filter(Visit %in% c("PP")) %>%
  group_by(ParticipantID) %>%
  summarize(
    PP_Waves = Total_rel[Visit == "PP"])
# add in GAD7 scores at T1
T1_GAD7 <-  Spec_Meta_data %>%
  subset(Visit == "T1") %>%
  dplyr::select(ParticipantID, loggad7_c,
                Healthcare_numeric, Race_Black,
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% T1_Wave_data$ParticipantID) %>%
  unique()
# Merge the wave change and depression data together
#################################################
Plot_data <- merge(PP_Wave_data, T1_GAD7, by = "ParticipantID")
# Linear Model
#################################################
lm.model <- lm(loggad7_c~ PP_Waves+Healthcare_numeric+Race_Black+Ethnicity_Hispanic,
            data = Plot_data)
summary(lm.model)
ggplotRegression(lm.model)   +
  theme_classic() +
  xlab("T1 Gamma Relative Power") +
  ylab("PP Scaled GAD7") +
  theme(axis.text.x =  element_text(family = "sans", color = "black", size =14),
        axis.text.y =  element_text(family = "sans", color = "black", size =14),
        axis.title.x =  element_text(family = "sans", color = "black", size =14),
        axis.title.y =  element_text(family = "sans", color = "black", size =14)) +
  geom_point(data = Plot_data, aes(x = PP_Waves,
                                   y = loggad7_c, color = SplitEGA_c)) +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  labs (color = "Scaled EGA")
```


### 3.5 - Predict T3 GAD7 from 20wk Waves

#### 3.5.1 - Alpha
```{r}
# Make a dataframe with the summarized data in it
#################################################
# Wave change
Wave_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Alpha") %>%
  filter(Visit %in% c("SV")) %>%
  group_by(ParticipantID) %>%
  summarize(
    Waves = Total_rel[Visit == "SV"])

T3_GAD7 <-  Spec_Meta_data %>%
  subset(Visit == "T3") %>%
  dplyr::select(ParticipantID, loggad7_c,
                Healthcare_numeric, Race_Black,
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wave_data$ParticipantID) %>%
  unique()
# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wave_data, T3_GAD7, by = "ParticipantID")
# Linear Model
#################################################
lm.model <- lm(loggad7_c~ Waves+Healthcare_numeric+Race_Black+Ethnicity_Hispanic,
            data = Plot_data)
summary(lm.model)
lm.model$SplitEGA_c<-Plot_data[row.names(model.frame(lm.model)),]$SplitEGA_c

ggplotRegression(lm.model)   +
  theme_classic() +
  xlab("20 GWs Alpha Relative Power") +
  ylab("36 GWs Adjusted GAD7") +
  theme(axis.text.x =  element_text(family = "sans", color = "black", size =14),
        axis.text.y =  element_text(family = "sans", color = "black", size =14),
        axis.title.x =  element_text(family = "sans", color = "black", size =20),
        axis.title.y =  element_text(family = "sans", color = "black", size =20)) +
  geom_point(data = lm.model , aes(x = lm.model$model[[2]], y = fitted(lm.model), col = lm.model$SplitEGA_c), size = 5, stroke = NA)  +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  labs (color = "Scaled EGA")
#####################################
#############################################################################

Plot_data_subset <- Plot_data[row.names(model.frame(lm.model)),]
# Find covariate adjusted loggad7_c
loggad7_c_adjusted <- with(Plot_data_subset, {
loggad7_c - 
 Healthcare_numeric * coef(lm.model)["Healthcare_numeric"] - 
 Ethnicity_Hispanic * coef(lm.model)["Ethnicity_Hispanic"] - 
 Race_Black * coef(lm.model)["Race_Black"]
})
#construct a dataframe with the adjusted values and the SplitEGA_c used for the point color scheme
adjusted <- data.frame(
  loggad7_c_adjusted = loggad7_c_adjusted,
  Waves = Plot_data_subset$Waves,
  SplitEGA_c = Plot_data_subset$SplitEGA_c  
)

#Plot!
 ggplot(adjusted, aes(x = Waves, y = loggad7_c_adjusted)) + 
    geom_point(data = adjusted, aes(x = Waves, y = loggad7_c_adjusted, col = adjusted$SplitEGA_c), size = 5, stroke = NA) +
    stat_smooth(method = "lm", col = "red", linetype = "dashed", linewidth = 1) +
    labs(title = paste("Adj R2 = ",signif(summary(lm.model)$adj.r.squared, 5),
                     "Intercept =",signif(lm.model$coef[[1]],5 ),
                     " Slope =",signif(lm.model$coef[[2]], 5),
                     " P =",signif(summary(lm.model)$coef[2,4], 5))) + theme_classic() + 
  xlab("20 GWs Relative Alpha Power") +
  ylab("36 GWs Adjusted GAD-7") +
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20), face = "bold") +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA") #+    ylim(-1, 1)



```

#### 3.5.2 -  Beta
```{r}
# Make a dataframe with the summarized data in it
#################################################
# Wave change
Wave_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Beta") %>%
  filter(Visit %in% c("SV")) %>%
  group_by(ParticipantID) %>%
  summarize(
    Waves = Total_rel[Visit == "SV"])

T3_GAD7 <-  Spec_Meta_data %>%
  subset(Visit == "T3") %>%
  dplyr::select(ParticipantID, loggad7_c,
                Healthcare_numeric, Race_Black,
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wave_data$ParticipantID) %>%
  unique()
# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wave_data, T3_GAD7, by = "ParticipantID")
# Linear Model
#################################################
lm.model <- lm(loggad7_c~ Waves+Healthcare_numeric+Race_Black+Ethnicity_Hispanic,
            data = Plot_data)
summary(lm.model)
lm.model$SplitEGA_c<-Plot_data[row.names(model.frame(lm.model)),]$SplitEGA_c

ggplotRegression(lm.model)   +
  theme_classic() +
  xlab("20 GWs Beta Relative Power") +
  ylab("36 GWs Adjusted GAD7") +
  theme(axis.text.x =  element_text(family = "sans", color = "black", size =14),
        axis.text.y =  element_text(family = "sans", color = "black", size =14),
        axis.title.x =  element_text(family = "sans", color = "black", size =20),
        axis.title.y =  element_text(family = "sans", color = "black", size =20)) +
  geom_point(data = lm.model , aes(x = lm.model$model[[2]], y = fitted(lm.model), col = lm.model$SplitEGA_c), size = 5, stroke = NA)  +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  labs (color = "Scaled EGA")


```


#### 3.5.3 -  Delta
```{r}
# Make a dataframe with the summarized data in it
#################################################
# Wave change
Wave_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Delta") %>%
  filter(Visit %in% c("SV")) %>%
  group_by(ParticipantID) %>%
  summarize(
    Waves = Total_rel[Visit == "SV"])

T3_GAD7 <-  Spec_Meta_data %>%
  subset(Visit == "T3") %>%
  dplyr::select(ParticipantID, loggad7_c,
                Healthcare_numeric, Race_Black,
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wave_data$ParticipantID) %>%
  unique()
# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wave_data, T3_GAD7, by = "ParticipantID")
# Linear Model
#################################################
lm.model <- lm(loggad7_c~ Waves+Healthcare_numeric+Race_Black+Ethnicity_Hispanic,
            data = Plot_data)
summary(lm.model)
lm.model$SplitEGA_c<-Plot_data[row.names(model.frame(lm.model)),]$SplitEGA_c

ggplotRegression(lm.model)   +
  theme_classic() +
  xlab("20 GWs Delta Relative Power") +
  ylab("36 GWs Adjusted GAD7") +
  theme(axis.text.x =  element_text(family = "sans", color = "black", size =14),
        axis.text.y =  element_text(family = "sans", color = "black", size =14),
        axis.title.x =  element_text(family = "sans", color = "black", size =20),
        axis.title.y =  element_text(family = "sans", color = "black", size =20)) +
  geom_point(data = lm.model , aes(x = lm.model$model[[2]], y = fitted(lm.model), col = lm.model$SplitEGA_c), size = 5, stroke = NA)  +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  labs (color = "Scaled EGA")
##################################################
#############################################################################
Plot_data_subset <- Plot_data[row.names(model.frame(lm.model)),]

# Find covariate adjusted loggad7_c
loggad7_c_adjusted <- with(Plot_data_subset, {
loggad7_c - 
 Healthcare_numeric * coef(lm.model)["Healthcare_numeric"] - 
 Ethnicity_Hispanic * coef(lm.model)["Ethnicity_Hispanic"] - 
 Race_Black * coef(lm.model)["Race_Black"]
})
#construct a dataframe with the adjusted values and the SplitEGA_c used for the point color scheme
adjusted <- data.frame(
  loggad7_c_adjusted = loggad7_c_adjusted,
  Waves = Plot_data_subset$Waves,
  SplitEGA_c = Plot_data_subset$SplitEGA_c  
)

#Plot!
 ggplot(adjusted, aes(x = Waves, y = loggad7_c_adjusted)) + 
    geom_point(data = adjusted, aes(x = Waves, y = loggad7_c_adjusted, col = adjusted$SplitEGA_c), size = 5, stroke = NA) +
    stat_smooth(method = "lm", col = "red", linetype = "dashed", linewidth = 1) +
    labs(title = paste("Adj R2 = ",signif(summary(lm.model)$adj.r.squared, 5),
                     "Intercept =",signif(lm.model$coef[[1]],5 ),
                     " Slope =",signif(lm.model$coef[[2]], 5),
                     " P =",signif(summary(lm.model)$coef[2,4], 5))) + theme_classic() + 
  xlab("20 GWs Relative Delta Power") +
  ylab("36 GWs Adjusted GAD-7") +
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20), face = "bold") +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA") #+    ylim(-1, 1)




```

#### 3.5.4 -  Theta
```{r}
# Make a dataframe with the summarized data in it
#################################################
# Wave change
Wave_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Theta") %>%
  filter(Visit %in% c("SV")) %>%
  group_by(ParticipantID) %>%
  summarize(
    Waves = Total_rel[Visit == "SV"])

T3_GAD7 <-  Spec_Meta_data %>%
  subset(Visit == "T3") %>%
  dplyr::select(ParticipantID, loggad7_c,
                Healthcare_numeric, Race_Black,
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wave_data$ParticipantID) %>%
  unique()
# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wave_data, T3_GAD7, by = "ParticipantID")
# Linear Model
#################################################
lm.model <- lm(loggad7_c~ Waves+Healthcare_numeric+Race_Black+Ethnicity_Hispanic,
            data = Plot_data)
summary(lm.model)
lm.model$SplitEGA_c<-Plot_data[row.names(model.frame(lm.model)),]$SplitEGA_c

ggplotRegression(lm.model)   +
  theme_classic() +
  xlab("20 GWs Theta Relative Power") +
  ylab("36 GWs Adjusted GAD7") +
  theme(axis.text.x =  element_text(family = "sans", color = "black", size =14),
        axis.text.y =  element_text(family = "sans", color = "black", size =14),
        axis.title.x =  element_text(family = "sans", color = "black", size =20),
        axis.title.y =  element_text(family = "sans", color = "black", size =20)) +
  geom_point(data = lm.model , aes(x = lm.model$model[[2]], y = fitted(lm.model), col = lm.model$SplitEGA_c), size = 5, stroke = NA)  +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  labs (color = "Scaled EGA")
```


#### 3.5.5 -  Gamma
```{r}
# Make a dataframe with the summarized data in it
#################################################
# Wave change
Wave_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Gamma") %>%
  filter(Visit %in% c("SV")) %>%
  group_by(ParticipantID) %>%
  summarize(
    Waves = Total_rel[Visit == "SV"])

T3_GAD7 <-  Spec_Meta_data %>%
  subset(Visit == "T3") %>%
  dplyr::select(ParticipantID, loggad7_c,
                Healthcare_numeric, Race_Black,
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wave_data$ParticipantID) %>%
  unique()
# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wave_data, T3_GAD7, by = "ParticipantID")
# Linear Model
#################################################
lm.model <- lm(loggad7_c~ Waves+Healthcare_numeric+Race_Black+Ethnicity_Hispanic,
            data = Plot_data)
summary(lm.model)
lm.model$SplitEGA_c<-Plot_data[row.names(model.frame(lm.model)),]$SplitEGA_c

ggplotRegression(lm.model)   +
  theme_classic() +
  xlab("20 GWs Gamma Relative Power") +
  ylab("36 GWs Adjusted GAD7") +
  theme(axis.text.x =  element_text(family = "sans", color = "black", size =14),
        axis.text.y =  element_text(family = "sans", color = "black", size =14),
        axis.title.x =  element_text(family = "sans", color = "black", size =20),
        axis.title.y =  element_text(family = "sans", color = "black", size =20)) +
  geom_point(data = lm.model , aes(x = lm.model$model[[2]], y = fitted(lm.model), col = lm.model$SplitEGA_c), size = 5, stroke = NA)  +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  labs (color = "Scaled EGA")
```



### 3.6 - Predict PP GAD7 from 20wk Waves

#### 3.6.1 - Alpha
```{r}
# Make a dataframe with the summarized data in it
#################################################
# Wave change
Wave_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Alpha") %>%
  filter(Visit %in% c("SV")) %>%
  group_by(ParticipantID) %>%
  summarize(
    Waves = Total_rel[Visit == "SV"])

PP_GAD7 <-  Spec_Meta_data %>%
  subset(Visit == "PP") %>%
  dplyr::select(ParticipantID, loggad7_c,
                Healthcare_numeric, Race_Black,
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wave_data$ParticipantID) %>%
  unique()
# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wave_data, PP_GAD7, by = "ParticipantID")
# Linear Model
#################################################
lm.model <- lm(loggad7_c~ Waves+Healthcare_numeric+Race_Black+Ethnicity_Hispanic,
            data = Plot_data)
summary(lm.model)
lm.model$SplitEGA_c<-Plot_data[row.names(model.frame(lm.model)),]$SplitEGA_c

ggplotRegression(lm.model)   +
  theme_classic() +
  xlab("20 GWs Alpha Relative Power") +
  ylab("Postpartum Adjusted GAD7") +
  theme(axis.text.x =  element_text(family = "sans", color = "black", size =14),
        axis.text.y =  element_text(family = "sans", color = "black", size =14),
        axis.title.x =  element_text(family = "sans", color = "black", size =20),
        axis.title.y =  element_text(family = "sans", color = "black", size =20)) +
  geom_point(data = lm.model , aes(x = lm.model$model[[2]], y = fitted(lm.model), col = lm.model$SplitEGA_c), size = 5, stroke = NA)  +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  labs (color = "Scaled EGA")

#############################################################################

Plot_data_subset <- Plot_data[row.names(model.frame(lm.model)),]

# Find covariate adjusted loggad7_c
loggad7_c_adjusted <- with(Plot_data_subset, {
loggad7_c - 
 Healthcare_numeric * coef(lm.model)["Healthcare_numeric"] - 
 Ethnicity_Hispanic * coef(lm.model)["Ethnicity_Hispanic"] - 
 Race_Black * coef(lm.model)["Race_Black"]
})
#construct a dataframe with the adjusted values and the SplitEGA_c used for the point color scheme
adjusted <- data.frame(
  loggad7_c_adjusted = loggad7_c_adjusted,
  Waves = Plot_data_subset$Waves,
  SplitEGA_c = Plot_data_subset$SplitEGA_c  
)

#Plot!
 ggplot(adjusted, aes(x = Waves, y = loggad7_c_adjusted)) + 
    geom_point(data = adjusted, aes(x = Waves, y = loggad7_c_adjusted, col = adjusted$SplitEGA_c), size = 5, stroke = NA) +
    stat_smooth(method = "lm", col = "red", linetype = "dashed", linewidth = 1) +
    labs(title = paste("Adj R2 = ",signif(summary(lm.model)$adj.r.squared, 5),
                     "Intercept =",signif(lm.model$coef[[1]],5 ),
                     " Slope =",signif(lm.model$coef[[2]], 5),
                     " P =",signif(summary(lm.model)$coef[2,4], 5))) + theme_classic() + 
  xlab("20 GWs Relative Alpha Power") +
  ylab("Postpartum Adjusted GAD-7") +
  theme(axis.text=element_text(size=14), axis.title=element_text(size=20), face = "bold") +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP"))+ labs (color = "Scaled EGA") #+    ylim(-1, 1)


```


#### 3.6.2 - Beta
```{r}
# Make a dataframe with the summarized data in it
#################################################
# Wave change
Wave_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Beta") %>%
  filter(Visit %in% c("SV")) %>%
  group_by(ParticipantID) %>%
  summarize(
    Waves = Total_rel[Visit == "SV"])

PP_GAD7 <-  Spec_Meta_data %>%
  subset(Visit == "PP") %>%
  dplyr::select(ParticipantID, loggad7_c,
                Healthcare_numeric, Race_Black,
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wave_data$ParticipantID) %>%
  unique()
# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wave_data, PP_GAD7, by = "ParticipantID")
# Linear Model
#################################################
lm.model <- lm(loggad7_c~ Waves+Healthcare_numeric+Race_Black+Ethnicity_Hispanic,
            data = Plot_data)
summary(lm.model)
lm.model$SplitEGA_c<-Plot_data[row.names(model.frame(lm.model)),]$SplitEGA_c

ggplotRegression(lm.model)   +
  theme_classic() +
  xlab("20 GWs Beta Relative Power") +
  ylab("Postpartum Adjusted GAD7") +
  theme(axis.text.x =  element_text(family = "sans", color = "black", size =14),
        axis.text.y =  element_text(family = "sans", color = "black", size =14),
        axis.title.x =  element_text(family = "sans", color = "black", size =20),
        axis.title.y =  element_text(family = "sans", color = "black", size =20)) +
  geom_point(data = lm.model , aes(x = lm.model$model[[2]], y = fitted(lm.model), col = lm.model$SplitEGA_c), size = 5, stroke = NA)  +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  labs (color = "Scaled EGA")


```

#### 3.6.3 - Delta
```{r}
# Make a dataframe with the summarized data in it
#################################################
# Wave change
Wave_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Delta") %>%
  filter(Visit %in% c("SV")) %>%
  group_by(ParticipantID) %>%
  summarize(
    Waves = Total_rel[Visit == "SV"])

PP_GAD7 <-  Spec_Meta_data %>%
  subset(Visit == "PP") %>%
  dplyr::select(ParticipantID, loggad7_c,
                Healthcare_numeric, Race_Black,
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wave_data$ParticipantID) %>%
  unique()
# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wave_data, PP_GAD7, by = "ParticipantID")
# Linear Model
#################################################
lm.model <- lm(loggad7_c~ Waves+Healthcare_numeric+Race_Black+Ethnicity_Hispanic,
            data = Plot_data)
summary(lm.model)
lm.model$SplitEGA_c<-Plot_data[row.names(model.frame(lm.model)),]$SplitEGA_c

ggplotRegression(lm.model)   +
  theme_classic() +
  xlab("20 GWs Delta Relative Power") +
  ylab("Postpartum Adjusted GAD7") +
  theme(axis.text.x =  element_text(family = "sans", color = "black", size =14),
        axis.text.y =  element_text(family = "sans", color = "black", size =14),
        axis.title.x =  element_text(family = "sans", color = "black", size =20),
        axis.title.y =  element_text(family = "sans", color = "black", size =20)) +
  geom_point(data = lm.model , aes(x = lm.model$model[[2]], y = fitted(lm.model), col = lm.model$SplitEGA_c), size = 5, stroke = NA)  +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  labs (color = "Scaled EGA")


```

#### 3.6.4 - Theta
```{r}
# Make a dataframe with the summarized data in it
#################################################
# Wave change
Wave_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Theta") %>%
  filter(Visit %in% c("SV")) %>%
  group_by(ParticipantID) %>%
  summarize(
    Waves = Total_rel[Visit == "SV"])

PP_GAD7 <-  Spec_Meta_data %>%
  subset(Visit == "PP") %>%
  dplyr::select(ParticipantID, loggad7_c,
                Healthcare_numeric, Race_Black,
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wave_data$ParticipantID) %>%
  unique()
# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wave_data, PP_GAD7, by = "ParticipantID")
# Linear Model
#################################################
lm.model <- lm(loggad7_c~ Waves+Healthcare_numeric+Race_Black+Ethnicity_Hispanic,
            data = Plot_data)
summary(lm.model)
lm.model$SplitEGA_c<-Plot_data[row.names(model.frame(lm.model)),]$SplitEGA_c

ggplotRegression(lm.model)   +
  theme_classic() +
  xlab("20 GWs Theta Relative Power") +
  ylab("Postpartum Adjusted GAD7") +
  theme(axis.text.x =  element_text(family = "sans", color = "black", size =14),
        axis.text.y =  element_text(family = "sans", color = "black", size =14),
        axis.title.x =  element_text(family = "sans", color = "black", size =20),
        axis.title.y =  element_text(family = "sans", color = "black", size =20)) +
  geom_point(data = lm.model , aes(x = lm.model$model[[2]], y = fitted(lm.model), col = lm.model$SplitEGA_c), size = 5, stroke = NA)  +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  labs (color = "Scaled EGA")


```

#### 3.6.5 - Gamma
```{r}
# Make a dataframe with the summarized data in it
#################################################
# Wave change
Wave_data <- Spec_Meta_data %>%
  subset(Freq_int_name == "Gamma") %>%
  filter(Visit %in% c("SV")) %>%
  group_by(ParticipantID) %>%
  summarize(
    Waves = Total_rel[Visit == "SV"])

PP_GAD7 <-  Spec_Meta_data %>%
  subset(Visit == "PP") %>%
  dplyr::select(ParticipantID, loggad7_c,
                Healthcare_numeric, Race_Black,
                Ethnicity_Hispanic, SplitEGA_c) %>%
  filter(ParticipantID %in% Wave_data$ParticipantID) %>%
  unique()
# Merge the wave change and depression data together
#################################################
Plot_data <- merge(Wave_data, PP_GAD7, by = "ParticipantID")
# Linear Model
#################################################
lm.model <- lm(loggad7_c~ Waves+Healthcare_numeric+Race_Black+Ethnicity_Hispanic,
            data = Plot_data)
summary(lm.model)
lm.model$SplitEGA_c<-Plot_data[row.names(model.frame(lm.model)),]$SplitEGA_c

ggplotRegression(lm.model)   +
  theme_classic() +
  xlab("20 GWs Gamma Relative Power") +
  ylab("Postpartum Adjusted GAD7") +
  theme(axis.text.x =  element_text(family = "sans", color = "black", size =14),
        axis.text.y =  element_text(family = "sans", color = "black", size =14),
        axis.title.x =  element_text(family = "sans", color = "black", size =20),
        axis.title.y =  element_text(family = "sans", color = "black", size =20)) +
  geom_point(data = lm.model , aes(x = lm.model$model[[2]], y = fitted(lm.model), col = lm.model$SplitEGA_c), size = 5, stroke = NA)  +
  scale_color_gradientn(
    colors = c("cyan", "darkblue", "orange", "red4"),
    values = c(0, 1, 1, 1.15) / 1.15,
    limits = c(0, 1.15),
    breaks = c(0, 0.5, 1, 1.15),
    labels = c("~0 Wks", "", "~40 Wks", "~6 Wks PP")
  ) +
  labs (color = "Scaled EGA")


```



